import{appendStyle as h}from"@neptune/utils";import{intercept as f}from"@neptune";import{dispatch as p}from"@neptune/store";import{addUnloadable as g}from"@plugin";import{addUnloadable as d}from"@plugin";var i=NeptuneNative.createEvalScope('var neptuneExports=(()=>{var xi=Object.create;var st=Object.defineProperty;var Ui=Object.getOwnPropertyDescriptor;var qi=Object.getOwnPropertyNames;var Bi=Object.getPrototypeOf,ji=Object.prototype.hasOwnProperty;var w=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+r+\'" is not supported\')});var Qi=(r,e)=>()=>(r&&(e=r(r=0)),e);var g=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),fn=(r,e)=>{for(var t in e)st(r,t,{get:e[t],enumerable:!0})},pn=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of qi(e))!ji.call(r,s)&&s!==t&&st(r,s,{get:()=>e[s],enumerable:!(n=Ui(e,s))||n.enumerable});return r};var tr=(r,e,t)=>(t=r!=null?xi(Bi(r)):{},pn(e||!r||!r.__esModule?st(t,"default",{value:r,enumerable:!0}):t,r)),A=r=>pn(st({},"__esModule",{value:!0}),r);var C={};fn(C,{__addDisposableResource:()=>Fn,__assign:()=>it,__asyncDelegator:()=>Nn,__asyncGenerator:()=>Cn,__asyncValues:()=>In,__await:()=>ve,__awaiter:()=>Rn,__classPrivateFieldGet:()=>On,__classPrivateFieldIn:()=>Mn,__classPrivateFieldSet:()=>Dn,__createBinding:()=>at,__decorate:()=>vn,__disposeResources:()=>kn,__esDecorate:()=>$i,__exportStar:()=>Sn,__extends:()=>gn,__generator:()=>_n,__importDefault:()=>Pn,__importStar:()=>Ln,__makeTemplateObject:()=>Tn,__metadata:()=>yn,__param:()=>wn,__propKey:()=>Wi,__read:()=>nr,__rest:()=>mn,__runInitializers:()=>Gi,__setFunctionName:()=>Hi,__spread:()=>bn,__spreadArray:()=>An,__spreadArrays:()=>En,__values:()=>ot,default:()=>zi});function gn(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");rr(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function mn(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(r);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(r,n[s])&&(t[n[s]]=r[n[s]]);return t}function vn(r,e,t,n){var s=arguments.length,i=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(i=(s<3?o(i):s>3?o(e,t,i):o(e,t))||i);return s>3&&i&&Object.defineProperty(e,t,i),i}function wn(r,e){return function(t,n){e(t,n,r)}}function $i(r,e,t,n,s,i){function o(y){if(y!==void 0&&typeof y!="function")throw new TypeError("Function expected");return y}for(var a=n.kind,c=a==="getter"?"get":a==="setter"?"set":"value",u=!e&&r?n.static?r:r.prototype:null,d=e||(u?Object.getOwnPropertyDescriptor(u,n.name):{}),l,h=!1,f=t.length-1;f>=0;f--){var v={};for(var m in n)v[m]=m==="access"?{}:n[m];for(var m in n.access)v.access[m]=n.access[m];v.addInitializer=function(y){if(h)throw new TypeError("Cannot add initializers after decoration has completed");i.push(o(y||null))};var R=(0,t[f])(a==="accessor"?{get:d.get,set:d.set}:d[c],v);if(a==="accessor"){if(R===void 0)continue;if(R===null||typeof R!="object")throw new TypeError("Object expected");(l=o(R.get))&&(d.get=l),(l=o(R.set))&&(d.set=l),(l=o(R.init))&&s.unshift(l)}else(l=o(R))&&(a==="field"?s.unshift(l):d[c]=l)}u&&Object.defineProperty(u,n.name,d),h=!0}function Gi(r,e,t){for(var n=arguments.length>2,s=0;s<e.length;s++)t=n?e[s].call(r,t):e[s].call(r);return n?t:void 0}function Wi(r){return typeof r=="symbol"?r:"".concat(r)}function Hi(r,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(r,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function yn(r,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,e)}function Rn(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{u(n.next(d))}catch(l){o(l)}}function c(d){try{u(n.throw(d))}catch(l){o(l)}}function u(d){d.done?i(d.value):s(d.value).then(a,c)}u((n=n.apply(r,e||[])).next())})}function _n(r,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(u){return function(d){return c([u,d])}}function c(u){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(t=0)),t;)try{if(n=1,s&&(i=u[0]&2?s.return:u[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,u[1])).done)return i;switch(s=0,i&&(u=[u[0]&2,i.value]),u[0]){case 0:case 1:i=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,s=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!i||u[1]>i[0]&&u[1]<i[3])){t.label=u[1];break}if(u[0]===6&&t.label<i[1]){t.label=i[1],i=u;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(u);break}i[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(r,t)}catch(d){u=[6,d],s=0}finally{n=i=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function Sn(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&at(e,r,t)}function ot(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function nr(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),s,i=[],o;try{for(;(e===void 0||e-- >0)&&!(s=n.next()).done;)i.push(s.value)}catch(a){o={error:a}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return i}function bn(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(nr(arguments[e]));return r}function En(){for(var r=0,e=0,t=arguments.length;e<t;e++)r+=arguments[e].length;for(var n=Array(r),s=0,e=0;e<t;e++)for(var i=arguments[e],o=0,a=i.length;o<a;o++,s++)n[s]=i[o];return n}function An(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))}function ve(r){return this instanceof ve?(this.v=r,this):new ve(r)}function Cn(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),s,i=[];return s={},a("next"),a("throw"),a("return",o),s[Symbol.asyncIterator]=function(){return this},s;function o(f){return function(v){return Promise.resolve(v).then(f,l)}}function a(f,v){n[f]&&(s[f]=function(m){return new Promise(function(R,y){i.push([f,m,R,y])>1||c(f,m)})},v&&(s[f]=v(s[f])))}function c(f,v){try{u(n[f](v))}catch(m){h(i[0][3],m)}}function u(f){f.value instanceof ve?Promise.resolve(f.value.v).then(d,l):h(i[0][2],f)}function d(f){c("next",f)}function l(f){c("throw",f)}function h(f,v){f(v),i.shift(),i.length&&c(i[0][0],i[0][1])}}function Nn(r){var e,t;return e={},n("next"),n("throw",function(s){throw s}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(s,i){e[s]=r[s]?function(o){return(t=!t)?{value:ve(r[s](o)),done:!1}:i?i(o):o}:i}}function In(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof ot=="function"?ot(r):r[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=r[i]&&function(o){return new Promise(function(a,c){o=r[i](o),s(a,c,o.done,o.value)})}}function s(i,o,a,c){Promise.resolve(c).then(function(u){i({value:u,done:a})},o)}}function Tn(r,e){return Object.defineProperty?Object.defineProperty(r,"raw",{value:e}):r.raw=e,r}function Ln(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&at(e,r,t);return Vi(e,r),e}function Pn(r){return r&&r.__esModule?r:{default:r}}function On(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}function Dn(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t}function Mn(r,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use \'in\' operator on non-object");return typeof r=="function"?e===r:r.has(e)}function Fn(r,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var n,s;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");n=e[Symbol.asyncDispose]}if(n===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");n=e[Symbol.dispose],t&&(s=n)}if(typeof n!="function")throw new TypeError("Object not disposable.");s&&(n=function(){try{s.call(this)}catch(i){return Promise.reject(i)}}),r.stack.push({value:e,dispose:n,async:t})}else t&&r.stack.push({async:!0});return e}function kn(r){function e(n){r.error=r.hasError?new Ki(n,r.error,"An error was suppressed during disposal."):n,r.hasError=!0}function t(){for(;r.stack.length;){var n=r.stack.pop();try{var s=n.dispose&&n.dispose.call(n.value);if(n.async)return Promise.resolve(s).then(t,function(i){return e(i),t()})}catch(i){e(i)}}if(r.hasError)throw r.error}return t()}var rr,it,at,Vi,Ki,zi,N=Qi(()=>{rr=function(r,e){return rr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])},rr(r,e)};it=function(){return it=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},it.apply(this,arguments)};at=Object.create?function(r,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,n,s)}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]};Vi=Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e};Ki=typeof SuppressedError=="function"?SuppressedError:function(r,e,t){var n=new Error(t);return n.name="SuppressedError",n.error=r,n.suppressed=e,n};zi={__extends:gn,__assign:it,__rest:mn,__decorate:vn,__param:wn,__metadata:yn,__awaiter:Rn,__generator:_n,__createBinding:at,__exportStar:Sn,__values:ot,__read:nr,__spread:bn,__spreadArrays:En,__spreadArray:An,__await:ve,__asyncGenerator:Cn,__asyncDelegator:Nn,__asyncValues:In,__makeTemplateObject:Tn,__importStar:Ln,__importDefault:Pn,__classPrivateFieldGet:On,__classPrivateFieldSet:Dn,__classPrivateFieldIn:Mn,__addDisposableResource:Fn,__disposeResources:kn}});var Un=g(sr=>{var xn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");sr.encode=function(r){if(0<=r&&r<xn.length)return xn[r];throw new TypeError("Must be between 0 and 63: "+r)};sr.decode=function(r){var e=65,t=90,n=97,s=122,i=48,o=57,a=43,c=47,u=26,d=52;return e<=r&&r<=t?r-e:n<=r&&r<=s?r-n+u:i<=r&&r<=o?r-i+d:r==a?62:r==c?63:-1}});var ar=g(or=>{var qn=Un(),ir=5,Bn=1<<ir,jn=Bn-1,Qn=Bn;function Yi(r){return r<0?(-r<<1)+1:(r<<1)+0}function Xi(r){var e=(r&1)===1,t=r>>1;return e?-t:t}or.encode=function(e){var t="",n,s=Yi(e);do n=s&jn,s>>>=ir,s>0&&(n|=Qn),t+=qn.encode(n);while(s>0);return t};or.decode=function(e,t,n){var s=e.length,i=0,o=0,a,c;do{if(t>=s)throw new Error("Expected more digits in base 64 VLQ value.");if(c=qn.decode(e.charCodeAt(t++)),c===-1)throw new Error("Invalid base64 digit: "+e.charAt(t-1));a=!!(c&Qn),c&=jn,i=i+(c<<o),o+=ir}while(a);n.value=Xi(i),n.rest=t}});var Re=g(M=>{function Zi(r,e,t){if(e in r)return r[e];if(arguments.length===3)return t;throw new Error(\'"\'+e+\'" is a required argument.\')}M.getArg=Zi;var $n=/^(?:([\\w+\\-.]+):)?\\/\\/(?:(\\w+:\\w+)@)?([\\w.-]*)(?::(\\d+))?(.*)$/,Ji=/^data:.+\\,.+$/;function ke(r){var e=r.match($n);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}M.urlParse=ke;function we(r){var e="";return r.scheme&&(e+=r.scheme+":"),e+="//",r.auth&&(e+=r.auth+"@"),r.host&&(e+=r.host),r.port&&(e+=":"+r.port),r.path&&(e+=r.path),e}M.urlGenerate=we;function cr(r){var e=r,t=ke(r);if(t){if(!t.path)return r;e=t.path}for(var n=M.isAbsolute(e),s=e.split(/\\/+/),i,o=0,a=s.length-1;a>=0;a--)i=s[a],i==="."?s.splice(a,1):i===".."?o++:o>0&&(i===""?(s.splice(a+1,o),o=0):(s.splice(a,2),o--));return e=s.join("/"),e===""&&(e=n?"/":"."),t?(t.path=e,we(t)):e}M.normalize=cr;function Gn(r,e){r===""&&(r="."),e===""&&(e=".");var t=ke(e),n=ke(r);if(n&&(r=n.path||"/"),t&&!t.scheme)return n&&(t.scheme=n.scheme),we(t);if(t||e.match(Ji))return e;if(n&&!n.host&&!n.path)return n.host=e,we(n);var s=e.charAt(0)==="/"?e:cr(r.replace(/\\/+$/,"")+"/"+e);return n?(n.path=s,we(n)):s}M.join=Gn;M.isAbsolute=function(r){return r.charAt(0)==="/"||$n.test(r)};function eo(r,e){r===""&&(r="."),r=r.replace(/\\/$/,"");for(var t=0;e.indexOf(r+"/")!==0;){var n=r.lastIndexOf("/");if(n<0||(r=r.slice(0,n),r.match(/^([^\\/]+:\\/)?\\/*$/)))return e;++t}return Array(t+1).join("../")+e.substr(r.length+1)}M.relative=eo;var Wn=function(){var r=Object.create(null);return!("__proto__"in r)}();function Hn(r){return r}function to(r){return Vn(r)?"$"+r:r}M.toSetString=Wn?Hn:to;function ro(r){return Vn(r)?r.slice(1):r}M.fromSetString=Wn?Hn:ro;function Vn(r){if(!r)return!1;var e=r.length;if(e<9||r.charCodeAt(e-1)!==95||r.charCodeAt(e-2)!==95||r.charCodeAt(e-3)!==111||r.charCodeAt(e-4)!==116||r.charCodeAt(e-5)!==111||r.charCodeAt(e-6)!==114||r.charCodeAt(e-7)!==112||r.charCodeAt(e-8)!==95||r.charCodeAt(e-9)!==95)return!1;for(var t=e-10;t>=0;t--)if(r.charCodeAt(t)!==36)return!1;return!0}function no(r,e,t){var n=ye(r.source,e.source);return n!==0||(n=r.originalLine-e.originalLine,n!==0)||(n=r.originalColumn-e.originalColumn,n!==0||t)||(n=r.generatedColumn-e.generatedColumn,n!==0)||(n=r.generatedLine-e.generatedLine,n!==0)?n:ye(r.name,e.name)}M.compareByOriginalPositions=no;function so(r,e,t){var n=r.generatedLine-e.generatedLine;return n!==0||(n=r.generatedColumn-e.generatedColumn,n!==0||t)||(n=ye(r.source,e.source),n!==0)||(n=r.originalLine-e.originalLine,n!==0)||(n=r.originalColumn-e.originalColumn,n!==0)?n:ye(r.name,e.name)}M.compareByGeneratedPositionsDeflated=so;function ye(r,e){return r===e?0:r===null?1:e===null?-1:r>e?1:-1}function io(r,e){var t=r.generatedLine-e.generatedLine;return t!==0||(t=r.generatedColumn-e.generatedColumn,t!==0)||(t=ye(r.source,e.source),t!==0)||(t=r.originalLine-e.originalLine,t!==0)||(t=r.originalColumn-e.originalColumn,t!==0)?t:ye(r.name,e.name)}M.compareByGeneratedPositionsInflated=io;function oo(r){return JSON.parse(r.replace(/^\\)]}\'[^\\n]*\\n/,""))}M.parseSourceMapInput=oo;function ao(r,e,t){if(e=e||"",r&&(r[r.length-1]!=="/"&&e[0]!=="/"&&(r+="/"),e=r+e),t){var n=ke(t);if(!n)throw new Error("sourceMapURL could not be parsed");if(n.path){var s=n.path.lastIndexOf("/");s>=0&&(n.path=n.path.substring(0,s+1))}e=Gn(we(n),e)}return cr(e)}M.computeSourceURL=ao});var lr=g(Kn=>{var ur=Re(),dr=Object.prototype.hasOwnProperty,le=typeof Map<"u";function X(){this._array=[],this._set=le?new Map:Object.create(null)}X.fromArray=function(e,t){for(var n=new X,s=0,i=e.length;s<i;s++)n.add(e[s],t);return n};X.prototype.size=function(){return le?this._set.size:Object.getOwnPropertyNames(this._set).length};X.prototype.add=function(e,t){var n=le?e:ur.toSetString(e),s=le?this.has(e):dr.call(this._set,n),i=this._array.length;(!s||t)&&this._array.push(e),s||(le?this._set.set(e,i):this._set[n]=i)};X.prototype.has=function(e){if(le)return this._set.has(e);var t=ur.toSetString(e);return dr.call(this._set,t)};X.prototype.indexOf=function(e){if(le){var t=this._set.get(e);if(t>=0)return t}else{var n=ur.toSetString(e);if(dr.call(this._set,n))return this._set[n]}throw new Error(\'"\'+e+\'" is not in the set.\')};X.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};X.prototype.toArray=function(){return this._array.slice()};Kn.ArraySet=X});var Xn=g(Yn=>{var zn=Re();function co(r,e){var t=r.generatedLine,n=e.generatedLine,s=r.generatedColumn,i=e.generatedColumn;return n>t||n==t&&i>=s||zn.compareByGeneratedPositionsInflated(r,e)<=0}function ct(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}ct.prototype.unsortedForEach=function(e,t){this._array.forEach(e,t)};ct.prototype.add=function(e){co(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};ct.prototype.toArray=function(){return this._sorted||(this._array.sort(zn.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};Yn.MappingList=ct});var hr=g(Zn=>{var xe=ar(),I=Re(),ut=lr().ArraySet,uo=Xn().MappingList;function q(r){r||(r={}),this._file=I.getArg(r,"file",null),this._sourceRoot=I.getArg(r,"sourceRoot",null),this._skipValidation=I.getArg(r,"skipValidation",!1),this._sources=new ut,this._names=new ut,this._mappings=new uo,this._sourcesContents=null}q.prototype._version=3;q.fromSourceMap=function(e){var t=e.sourceRoot,n=new q({file:e.file,sourceRoot:t});return e.eachMapping(function(s){var i={generated:{line:s.generatedLine,column:s.generatedColumn}};s.source!=null&&(i.source=s.source,t!=null&&(i.source=I.relative(t,i.source)),i.original={line:s.originalLine,column:s.originalColumn},s.name!=null&&(i.name=s.name)),n.addMapping(i)}),e.sources.forEach(function(s){var i=s;t!==null&&(i=I.relative(t,s)),n._sources.has(i)||n._sources.add(i);var o=e.sourceContentFor(s);o!=null&&n.setSourceContent(s,o)}),n};q.prototype.addMapping=function(e){var t=I.getArg(e,"generated"),n=I.getArg(e,"original",null),s=I.getArg(e,"source",null),i=I.getArg(e,"name",null);this._skipValidation||this._validateMapping(t,n,s,i),s!=null&&(s=String(s),this._sources.has(s)||this._sources.add(s)),i!=null&&(i=String(i),this._names.has(i)||this._names.add(i)),this._mappings.add({generatedLine:t.line,generatedColumn:t.column,originalLine:n!=null&&n.line,originalColumn:n!=null&&n.column,source:s,name:i})};q.prototype.setSourceContent=function(e,t){var n=e;this._sourceRoot!=null&&(n=I.relative(this._sourceRoot,n)),t!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[I.toSetString(n)]=t):this._sourcesContents&&(delete this._sourcesContents[I.toSetString(n)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};q.prototype.applySourceMap=function(e,t,n){var s=t;if(t==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map\'s "file" property. Both were omitted.`);s=e.file}var i=this._sourceRoot;i!=null&&(s=I.relative(i,s));var o=new ut,a=new ut;this._mappings.unsortedForEach(function(c){if(c.source===s&&c.originalLine!=null){var u=e.originalPositionFor({line:c.originalLine,column:c.originalColumn});u.source!=null&&(c.source=u.source,n!=null&&(c.source=I.join(n,c.source)),i!=null&&(c.source=I.relative(i,c.source)),c.originalLine=u.line,c.originalColumn=u.column,u.name!=null&&(c.name=u.name))}var d=c.source;d!=null&&!o.has(d)&&o.add(d);var l=c.name;l!=null&&!a.has(l)&&a.add(l)},this),this._sources=o,this._names=a,e.sources.forEach(function(c){var u=e.sourceContentFor(c);u!=null&&(n!=null&&(c=I.join(n,c)),i!=null&&(c=I.relative(i,c)),this.setSourceContent(c,u))},this)};q.prototype._validateMapping=function(e,t,n,s){if(t&&typeof t.line!="number"&&typeof t.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!t&&!n&&!s)){if(e&&"line"in e&&"column"in e&&t&&"line"in t&&"column"in t&&e.line>0&&e.column>=0&&t.line>0&&t.column>=0&&n)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:n,original:t,name:s}))}};q.prototype._serializeMappings=function(){for(var e=0,t=1,n=0,s=0,i=0,o=0,a="",c,u,d,l,h=this._mappings.toArray(),f=0,v=h.length;f<v;f++){if(u=h[f],c="",u.generatedLine!==t)for(e=0;u.generatedLine!==t;)c+=";",t++;else if(f>0){if(!I.compareByGeneratedPositionsInflated(u,h[f-1]))continue;c+=","}c+=xe.encode(u.generatedColumn-e),e=u.generatedColumn,u.source!=null&&(l=this._sources.indexOf(u.source),c+=xe.encode(l-o),o=l,c+=xe.encode(u.originalLine-1-s),s=u.originalLine-1,c+=xe.encode(u.originalColumn-n),n=u.originalColumn,u.name!=null&&(d=this._names.indexOf(u.name),c+=xe.encode(d-i),i=d)),a+=c}return a};q.prototype._generateSourcesContent=function(e,t){return e.map(function(n){if(!this._sourcesContents)return null;t!=null&&(n=I.relative(t,n));var s=I.toSetString(n);return Object.prototype.hasOwnProperty.call(this._sourcesContents,s)?this._sourcesContents[s]:null},this)};q.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};q.prototype.toString=function(){return JSON.stringify(this.toJSON())};Zn.SourceMapGenerator=q});var Jn=g(he=>{he.GREATEST_LOWER_BOUND=1;he.LEAST_UPPER_BOUND=2;function fr(r,e,t,n,s,i){var o=Math.floor((e-r)/2)+r,a=s(t,n[o],!0);return a===0?o:a>0?e-o>1?fr(o,e,t,n,s,i):i==he.LEAST_UPPER_BOUND?e<n.length?e:-1:o:o-r>1?fr(r,o,t,n,s,i):i==he.LEAST_UPPER_BOUND?o:r<0?-1:r}he.search=function(e,t,n,s){if(t.length===0)return-1;var i=fr(-1,t.length,e,t,n,s||he.GREATEST_LOWER_BOUND);if(i<0)return-1;for(;i-1>=0&&n(t[i],t[i-1],!0)===0;)--i;return i}});var ts=g(es=>{function pr(r,e,t){var n=r[e];r[e]=r[t],r[t]=n}function lo(r,e){return Math.round(r+Math.random()*(e-r))}function gr(r,e,t,n){if(t<n){var s=lo(t,n),i=t-1;pr(r,s,n);for(var o=r[n],a=t;a<n;a++)e(r[a],o)<=0&&(i+=1,pr(r,i,a));pr(r,i+1,a);var c=i+1;gr(r,e,t,c-1),gr(r,e,c+1,n)}}es.quickSort=function(r,e){gr(r,e,0,r.length-1)}});var ns=g(dt=>{var p=Re(),mr=Jn(),_e=lr().ArraySet,ho=ar(),Ue=ts().quickSort;function S(r,e){var t=r;return typeof r=="string"&&(t=p.parseSourceMapInput(r)),t.sections!=null?new G(t,e):new P(t,e)}S.fromSourceMap=function(r,e){return P.fromSourceMap(r,e)};S.prototype._version=3;S.prototype.__generatedMappings=null;Object.defineProperty(S.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});S.prototype.__originalMappings=null;Object.defineProperty(S.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});S.prototype._charIsMappingSeparator=function(e,t){var n=e.charAt(t);return n===";"||n===","};S.prototype._parseMappings=function(e,t){throw new Error("Subclasses must implement _parseMappings")};S.GENERATED_ORDER=1;S.ORIGINAL_ORDER=2;S.GREATEST_LOWER_BOUND=1;S.LEAST_UPPER_BOUND=2;S.prototype.eachMapping=function(e,t,n){var s=t||null,i=n||S.GENERATED_ORDER,o;switch(i){case S.GENERATED_ORDER:o=this._generatedMappings;break;case S.ORIGINAL_ORDER:o=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;o.map(function(c){var u=c.source===null?null:this._sources.at(c.source);return u=p.computeSourceURL(a,u,this._sourceMapURL),{source:u,generatedLine:c.generatedLine,generatedColumn:c.generatedColumn,originalLine:c.originalLine,originalColumn:c.originalColumn,name:c.name===null?null:this._names.at(c.name)}},this).forEach(e,s)};S.prototype.allGeneratedPositionsFor=function(e){var t=p.getArg(e,"line"),n={source:p.getArg(e,"source"),originalLine:t,originalColumn:p.getArg(e,"column",0)};if(n.source=this._findSourceIndex(n.source),n.source<0)return[];var s=[],i=this._findMapping(n,this._originalMappings,"originalLine","originalColumn",p.compareByOriginalPositions,mr.LEAST_UPPER_BOUND);if(i>=0){var o=this._originalMappings[i];if(e.column===void 0)for(var a=o.originalLine;o&&o.originalLine===a;)s.push({line:p.getArg(o,"generatedLine",null),column:p.getArg(o,"generatedColumn",null),lastColumn:p.getArg(o,"lastGeneratedColumn",null)}),o=this._originalMappings[++i];else for(var c=o.originalColumn;o&&o.originalLine===t&&o.originalColumn==c;)s.push({line:p.getArg(o,"generatedLine",null),column:p.getArg(o,"generatedColumn",null),lastColumn:p.getArg(o,"lastGeneratedColumn",null)}),o=this._originalMappings[++i]}return s};dt.SourceMapConsumer=S;function P(r,e){var t=r;typeof r=="string"&&(t=p.parseSourceMapInput(r));var n=p.getArg(t,"version"),s=p.getArg(t,"sources"),i=p.getArg(t,"names",[]),o=p.getArg(t,"sourceRoot",null),a=p.getArg(t,"sourcesContent",null),c=p.getArg(t,"mappings"),u=p.getArg(t,"file",null);if(n!=this._version)throw new Error("Unsupported version: "+n);o&&(o=p.normalize(o)),s=s.map(String).map(p.normalize).map(function(d){return o&&p.isAbsolute(o)&&p.isAbsolute(d)?p.relative(o,d):d}),this._names=_e.fromArray(i.map(String),!0),this._sources=_e.fromArray(s,!0),this._absoluteSources=this._sources.toArray().map(function(d){return p.computeSourceURL(o,d,e)}),this.sourceRoot=o,this.sourcesContent=a,this._mappings=c,this._sourceMapURL=e,this.file=u}P.prototype=Object.create(S.prototype);P.prototype.consumer=S;P.prototype._findSourceIndex=function(r){var e=r;if(this.sourceRoot!=null&&(e=p.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var t;for(t=0;t<this._absoluteSources.length;++t)if(this._absoluteSources[t]==r)return t;return-1};P.fromSourceMap=function(e,t){var n=Object.create(P.prototype),s=n._names=_e.fromArray(e._names.toArray(),!0),i=n._sources=_e.fromArray(e._sources.toArray(),!0);n.sourceRoot=e._sourceRoot,n.sourcesContent=e._generateSourcesContent(n._sources.toArray(),n.sourceRoot),n.file=e._file,n._sourceMapURL=t,n._absoluteSources=n._sources.toArray().map(function(f){return p.computeSourceURL(n.sourceRoot,f,t)});for(var o=e._mappings.toArray().slice(),a=n.__generatedMappings=[],c=n.__originalMappings=[],u=0,d=o.length;u<d;u++){var l=o[u],h=new rs;h.generatedLine=l.generatedLine,h.generatedColumn=l.generatedColumn,l.source&&(h.source=i.indexOf(l.source),h.originalLine=l.originalLine,h.originalColumn=l.originalColumn,l.name&&(h.name=s.indexOf(l.name)),c.push(h)),a.push(h)}return Ue(n.__originalMappings,p.compareByOriginalPositions),n};P.prototype._version=3;Object.defineProperty(P.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function rs(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}P.prototype._parseMappings=function(e,t){for(var n=1,s=0,i=0,o=0,a=0,c=0,u=e.length,d=0,l={},h={},f=[],v=[],m,R,y,E,rt;d<u;)if(e.charAt(d)===";")n++,d++,s=0;else if(e.charAt(d)===",")d++;else{for(m=new rs,m.generatedLine=n,E=d;E<u&&!this._charIsMappingSeparator(e,E);E++);if(R=e.slice(d,E),y=l[R],y)d+=R.length;else{for(y=[];d<E;)ho.decode(e,d,h),rt=h.value,d=h.rest,y.push(rt);if(y.length===2)throw new Error("Found a source, but no line and column");if(y.length===3)throw new Error("Found a source and line, but no column");l[R]=y}m.generatedColumn=s+y[0],s=m.generatedColumn,y.length>1&&(m.source=a+y[1],a+=y[1],m.originalLine=i+y[2],i=m.originalLine,m.originalLine+=1,m.originalColumn=o+y[3],o=m.originalColumn,y.length>4&&(m.name=c+y[4],c+=y[4])),v.push(m),typeof m.originalLine=="number"&&f.push(m)}Ue(v,p.compareByGeneratedPositionsDeflated),this.__generatedMappings=v,Ue(f,p.compareByOriginalPositions),this.__originalMappings=f};P.prototype._findMapping=function(e,t,n,s,i,o){if(e[n]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[n]);if(e[s]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[s]);return mr.search(e,t,i,o)};P.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var t=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var n=this._generatedMappings[e+1];if(t.generatedLine===n.generatedLine){t.lastGeneratedColumn=n.generatedColumn-1;continue}}t.lastGeneratedColumn=1/0}};P.prototype.originalPositionFor=function(e){var t={generatedLine:p.getArg(e,"line"),generatedColumn:p.getArg(e,"column")},n=this._findMapping(t,this._generatedMappings,"generatedLine","generatedColumn",p.compareByGeneratedPositionsDeflated,p.getArg(e,"bias",S.GREATEST_LOWER_BOUND));if(n>=0){var s=this._generatedMappings[n];if(s.generatedLine===t.generatedLine){var i=p.getArg(s,"source",null);i!==null&&(i=this._sources.at(i),i=p.computeSourceURL(this.sourceRoot,i,this._sourceMapURL));var o=p.getArg(s,"name",null);return o!==null&&(o=this._names.at(o)),{source:i,line:p.getArg(s,"originalLine",null),column:p.getArg(s,"originalColumn",null),name:o}}}return{source:null,line:null,column:null,name:null}};P.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};P.prototype.sourceContentFor=function(e,t){if(!this.sourcesContent)return null;var n=this._findSourceIndex(e);if(n>=0)return this.sourcesContent[n];var s=e;this.sourceRoot!=null&&(s=p.relative(this.sourceRoot,s));var i;if(this.sourceRoot!=null&&(i=p.urlParse(this.sourceRoot))){var o=s.replace(/^file:\\/\\//,"");if(i.scheme=="file"&&this._sources.has(o))return this.sourcesContent[this._sources.indexOf(o)];if((!i.path||i.path=="/")&&this._sources.has("/"+s))return this.sourcesContent[this._sources.indexOf("/"+s)]}if(t)return null;throw new Error(\'"\'+s+\'" is not in the SourceMap.\')};P.prototype.generatedPositionFor=function(e){var t=p.getArg(e,"source");if(t=this._findSourceIndex(t),t<0)return{line:null,column:null,lastColumn:null};var n={source:t,originalLine:p.getArg(e,"line"),originalColumn:p.getArg(e,"column")},s=this._findMapping(n,this._originalMappings,"originalLine","originalColumn",p.compareByOriginalPositions,p.getArg(e,"bias",S.GREATEST_LOWER_BOUND));if(s>=0){var i=this._originalMappings[s];if(i.source===n.source)return{line:p.getArg(i,"generatedLine",null),column:p.getArg(i,"generatedColumn",null),lastColumn:p.getArg(i,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};dt.BasicSourceMapConsumer=P;function G(r,e){var t=r;typeof r=="string"&&(t=p.parseSourceMapInput(r));var n=p.getArg(t,"version"),s=p.getArg(t,"sections");if(n!=this._version)throw new Error("Unsupported version: "+n);this._sources=new _e,this._names=new _e;var i={line:-1,column:0};this._sections=s.map(function(o){if(o.url)throw new Error("Support for url field in sections not implemented.");var a=p.getArg(o,"offset"),c=p.getArg(a,"line"),u=p.getArg(a,"column");if(c<i.line||c===i.line&&u<i.column)throw new Error("Section offsets must be ordered and non-overlapping.");return i=a,{generatedOffset:{generatedLine:c+1,generatedColumn:u+1},consumer:new S(p.getArg(o,"map"),e)}})}G.prototype=Object.create(S.prototype);G.prototype.constructor=S;G.prototype._version=3;Object.defineProperty(G.prototype,"sources",{get:function(){for(var r=[],e=0;e<this._sections.length;e++)for(var t=0;t<this._sections[e].consumer.sources.length;t++)r.push(this._sections[e].consumer.sources[t]);return r}});G.prototype.originalPositionFor=function(e){var t={generatedLine:p.getArg(e,"line"),generatedColumn:p.getArg(e,"column")},n=mr.search(t,this._sections,function(i,o){var a=i.generatedLine-o.generatedOffset.generatedLine;return a||i.generatedColumn-o.generatedOffset.generatedColumn}),s=this._sections[n];return s?s.consumer.originalPositionFor({line:t.generatedLine-(s.generatedOffset.generatedLine-1),column:t.generatedColumn-(s.generatedOffset.generatedLine===t.generatedLine?s.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};G.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};G.prototype.sourceContentFor=function(e,t){for(var n=0;n<this._sections.length;n++){var s=this._sections[n],i=s.consumer.sourceContentFor(e,!0);if(i)return i}if(t)return null;throw new Error(\'"\'+e+\'" is not in the SourceMap.\')};G.prototype.generatedPositionFor=function(e){for(var t=0;t<this._sections.length;t++){var n=this._sections[t];if(n.consumer._findSourceIndex(p.getArg(e,"source"))!==-1){var s=n.consumer.generatedPositionFor(e);if(s){var i={line:s.line+(n.generatedOffset.generatedLine-1),column:s.column+(n.generatedOffset.generatedLine===s.line?n.generatedOffset.generatedColumn-1:0)};return i}}}return{line:null,column:null}};G.prototype._parseMappings=function(e,t){this.__generatedMappings=[],this.__originalMappings=[];for(var n=0;n<this._sections.length;n++)for(var s=this._sections[n],i=s.consumer._generatedMappings,o=0;o<i.length;o++){var a=i[o],c=s.consumer._sources.at(a.source);c=p.computeSourceURL(s.consumer.sourceRoot,c,this._sourceMapURL),this._sources.add(c),c=this._sources.indexOf(c);var u=null;a.name&&(u=s.consumer._names.at(a.name),this._names.add(u),u=this._names.indexOf(u));var d={source:c,generatedLine:a.generatedLine+(s.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(s.generatedOffset.generatedLine===a.generatedLine?s.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:u};this.__generatedMappings.push(d),typeof d.originalLine=="number"&&this.__originalMappings.push(d)}Ue(this.__generatedMappings,p.compareByGeneratedPositionsDeflated),Ue(this.__originalMappings,p.compareByOriginalPositions)};dt.IndexedSourceMapConsumer=G});var is=g(ss=>{var fo=hr().SourceMapGenerator,lt=Re(),po=/(\\r?\\n)/,go=10,Se="$$$isSourceNode$$$";function F(r,e,t,n,s){this.children=[],this.sourceContents={},this.line=r??null,this.column=e??null,this.source=t??null,this.name=s??null,this[Se]=!0,n!=null&&this.add(n)}F.fromStringWithSourceMap=function(e,t,n){var s=new F,i=e.split(po),o=0,a=function(){var h=v(),f=v()||"";return h+f;function v(){return o<i.length?i[o++]:void 0}},c=1,u=0,d=null;return t.eachMapping(function(h){if(d!==null)if(c<h.generatedLine)l(d,a()),c++,u=0;else{var f=i[o]||"",v=f.substr(0,h.generatedColumn-u);i[o]=f.substr(h.generatedColumn-u),u=h.generatedColumn,l(d,v),d=h;return}for(;c<h.generatedLine;)s.add(a()),c++;if(u<h.generatedColumn){var f=i[o]||"";s.add(f.substr(0,h.generatedColumn)),i[o]=f.substr(h.generatedColumn),u=h.generatedColumn}d=h},this),o<i.length&&(d&&l(d,a()),s.add(i.splice(o).join(""))),t.sources.forEach(function(h){var f=t.sourceContentFor(h);f!=null&&(n!=null&&(h=lt.join(n,h)),s.setSourceContent(h,f))}),s;function l(h,f){if(h===null||h.source===void 0)s.add(f);else{var v=n?lt.join(n,h.source):h.source;s.add(new F(h.originalLine,h.originalColumn,v,f,h.name))}}};F.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(t){this.add(t)},this);else if(e[Se]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};F.prototype.prepend=function(e){if(Array.isArray(e))for(var t=e.length-1;t>=0;t--)this.prepend(e[t]);else if(e[Se]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};F.prototype.walk=function(e){for(var t,n=0,s=this.children.length;n<s;n++)t=this.children[n],t[Se]?t.walk(e):t!==""&&e(t,{source:this.source,line:this.line,column:this.column,name:this.name})};F.prototype.join=function(e){var t,n,s=this.children.length;if(s>0){for(t=[],n=0;n<s-1;n++)t.push(this.children[n]),t.push(e);t.push(this.children[n]),this.children=t}return this};F.prototype.replaceRight=function(e,t){var n=this.children[this.children.length-1];return n[Se]?n.replaceRight(e,t):typeof n=="string"?this.children[this.children.length-1]=n.replace(e,t):this.children.push("".replace(e,t)),this};F.prototype.setSourceContent=function(e,t){this.sourceContents[lt.toSetString(e)]=t};F.prototype.walkSourceContents=function(e){for(var t=0,n=this.children.length;t<n;t++)this.children[t][Se]&&this.children[t].walkSourceContents(e);for(var s=Object.keys(this.sourceContents),t=0,n=s.length;t<n;t++)e(lt.fromSetString(s[t]),this.sourceContents[s[t]])};F.prototype.toString=function(){var e="";return this.walk(function(t){e+=t}),e};F.prototype.toStringWithSourceMap=function(e){var t={code:"",line:1,column:0},n=new fo(e),s=!1,i=null,o=null,a=null,c=null;return this.walk(function(u,d){t.code+=u,d.source!==null&&d.line!==null&&d.column!==null?((i!==d.source||o!==d.line||a!==d.column||c!==d.name)&&n.addMapping({source:d.source,original:{line:d.line,column:d.column},generated:{line:t.line,column:t.column},name:d.name}),i=d.source,o=d.line,a=d.column,c=d.name,s=!0):s&&(n.addMapping({generated:{line:t.line,column:t.column}}),i=null,s=!1);for(var l=0,h=u.length;l<h;l++)u.charCodeAt(l)===go?(t.line++,t.column=0,l+1===h?(i=null,s=!1):s&&n.addMapping({source:d.source,original:{line:d.line,column:d.column},generated:{line:t.line,column:t.column},name:d.name})):t.column++}),this.walkSourceContents(function(u,d){n.setSourceContent(u,d)}),{code:t.code,map:n}};ss.SourceNode=F});var os=g(ht=>{ht.SourceMapGenerator=hr().SourceMapGenerator;ht.SourceMapConsumer=ns().SourceMapConsumer;ht.SourceNode=is().SourceNode});var cs=g((mu,as)=>{var mo=Object.prototype.toString,vr=typeof Buffer<"u"&&typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function vo(r){return mo.call(r).slice(8,-1)==="ArrayBuffer"}function wo(r,e,t){e>>>=0;var n=r.byteLength-e;if(n<0)throw new RangeError("\'offset\' is out of bounds");if(t===void 0)t=n;else if(t>>>=0,t>n)throw new RangeError("\'length\' is out of bounds");return vr?Buffer.from(r.slice(e,e+t)):new Buffer(new Uint8Array(r.slice(e,e+t)))}function yo(r,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError(\'"encoding" must be a valid string encoding\');return vr?Buffer.from(r,e):new Buffer(r,e)}function Ro(r,e,t){if(typeof r=="number")throw new TypeError(\'"value" argument must not be a number\');return vo(r)?wo(r,e,t):typeof r=="string"?yo(r,e):vr?Buffer.from(r):new Buffer(r)}as.exports=Ro});var ms=g((pe,_r)=>{var _o=os().SourceMapConsumer,wr=w("path"),z;try{z=w("fs"),(!z.existsSync||!z.readFileSync)&&(z=null)}catch{}var So=cs();function us(r,e){return r.require(e)}var ds=!1,ls=!1,yr=!1,qe="auto",fe={},Be={},bo=/^data:application\\/json[^,]+base64,/,te=[],re=[];function Sr(){return qe==="browser"?!0:qe==="node"?!1:typeof window<"u"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function Eo(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function Ao(){return typeof process=="object"&&process!==null?process.version:""}function Co(){if(typeof process=="object"&&process!==null)return process.stderr}function No(r){if(typeof process=="object"&&process!==null&&typeof process.exit=="function")return process.exit(r)}function ft(r){return function(e){for(var t=0;t<r.length;t++){var n=r[t](e);if(n)return n}return null}}var br=ft(te);te.push(function(r){if(r=r.trim(),/^file:/.test(r)&&(r=r.replace(/file:\\/\\/\\/(\\w:)?/,function(n,s){return s?"":"/"})),r in fe)return fe[r];var e="";try{if(z)z.existsSync(r)&&(e=z.readFileSync(r,"utf8"));else{var t=new XMLHttpRequest;t.open("GET",r,!1),t.send(null),t.readyState===4&&t.status===200&&(e=t.responseText)}}catch{}return fe[r]=e});function Rr(r,e){if(!r)return e;var t=wr.dirname(r),n=/^\\w+:\\/\\/[^\\/]*/.exec(t),s=n?n[0]:"",i=t.slice(s.length);return s&&/^\\/\\w\\:/.test(i)?(s+="/",s+wr.resolve(t.slice(s.length),e).replace(/\\\\/g,"/")):s+wr.resolve(t.slice(s.length),e)}function Io(r){var e;if(Sr())try{var t=new XMLHttpRequest;t.open("GET",r,!1),t.send(null),e=t.readyState===4?t.responseText:null;var n=t.getResponseHeader("SourceMap")||t.getResponseHeader("X-SourceMap");if(n)return n}catch{}e=br(r);for(var s=/(?:\\/\\/[@#][\\s]*sourceMappingURL=([^\\s\'"]+)[\\s]*$)|(?:\\/\\*[@#][\\s]*sourceMappingURL=([^\\s*\'"]+)[\\s]*(?:\\*\\/)[\\s]*$)/mg,i,o;o=s.exec(e);)i=o;return i?i[1]:null}var Er=ft(re);re.push(function(r){var e=Io(r);if(!e)return null;var t;if(bo.test(e)){var n=e.slice(e.indexOf(",")+1);t=So(n,"base64").toString(),e=r}else e=Rr(r,e),t=br(e);return t?{url:e,map:t}:null});function Ar(r){var e=Be[r.source];if(!e){var t=Er(r.source);t?(e=Be[r.source]={url:t.url,map:new _o(t.map)},e.map.sourcesContent&&e.map.sources.forEach(function(s,i){var o=e.map.sourcesContent[i];if(o){var a=Rr(e.url,s);fe[a]=o}})):e=Be[r.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var n=e.map.originalPositionFor(r);if(n.source!==null)return n.source=Rr(e.url,n.source),n}return r}function fs(r){var e=/^eval at ([^(]+) \\((.+):(\\d+):(\\d+)\\)$/.exec(r);if(e){var t=Ar({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+t.source+":"+t.line+":"+(t.column+1)+")"}return e=/^eval at ([^(]+) \\((.+)\\)$/.exec(r),e?"eval at "+e[1]+" ("+fs(e[2])+")":r}function To(){var r,e="";if(this.isNative())e="native";else{r=this.getScriptNameOrSourceURL(),!r&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),r?e+=r:e+="<anonymous>";var t=this.getLineNumber();if(t!=null){e+=":"+t;var n=this.getColumnNumber();n&&(e+=":"+n)}}var s="",i=this.getFunctionName(),o=!0,a=this.isConstructor(),c=!(this.isToplevel()||a);if(c){var u=this.getTypeName();u==="[object Object]"&&(u="null");var d=this.getMethodName();i?(u&&i.indexOf(u)!=0&&(s+=u+"."),s+=i,d&&i.indexOf("."+d)!=i.length-d.length-1&&(s+=" [as "+d+"]")):s+=u+"."+(d||"<anonymous>")}else a?s+="new "+(i||"<anonymous>"):i?s+=i:(s+=e,o=!1);return o&&(s+=" ("+e+")"),s}function hs(r){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(r)).forEach(function(t){e[t]=/^(?:is|get)/.test(t)?function(){return r[t].call(r)}:r[t]}),e.toString=To,e}function ps(r,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),r.isNative())return e.curPosition=null,r;var t=r.getFileName()||r.getScriptNameOrSourceURL();if(t){var n=r.getLineNumber(),s=r.getColumnNumber()-1,i=/^v(10\\.1[6-9]|10\\.[2-9][0-9]|10\\.[0-9]{3,}|1[2-9]\\d*|[2-9]\\d|\\d{3,}|11\\.11)/,o=i.test(Ao())?0:62;n===1&&s>o&&!Sr()&&!r.isEval()&&(s-=o);var a=Ar({source:t,line:n,column:s});e.curPosition=a,r=hs(r);var c=r.getFunctionName;return r.getFunctionName=function(){return e.nextPosition==null?c():e.nextPosition.name||c()},r.getFileName=function(){return a.source},r.getLineNumber=function(){return a.line},r.getColumnNumber=function(){return a.column+1},r.getScriptNameOrSourceURL=function(){return a.source},r}var u=r.isEval()&&r.getEvalOrigin();return u&&(u=fs(u),r=hs(r),r.getEvalOrigin=function(){return u}),r}function Lo(r,e){yr&&(fe={},Be={});for(var t=r.name||"Error",n=r.message||"",s=t+": "+n,i={nextPosition:null,curPosition:null},o=[],a=e.length-1;a>=0;a--)o.push(`\n    at `+ps(e[a],i)),i.nextPosition=i.curPosition;return i.curPosition=i.nextPosition=null,s+o.reverse().join("")}function gs(r){var e=/\\n    at [^(]+ \\((.*):(\\d+):(\\d+)\\)/.exec(r.stack);if(e){var t=e[1],n=+e[2],s=+e[3],i=fe[t];if(!i&&z&&z.existsSync(t))try{i=z.readFileSync(t,"utf8")}catch{i=""}if(i){var o=i.split(/(?:\\r\\n|\\r|\\n)/)[n-1];if(o)return t+":"+n+`\n`+o+`\n`+new Array(s).join(" ")+"^"}}return null}function Po(r){var e=gs(r),t=Co();t&&t._handle&&t._handle.setBlocking&&t._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(r.stack),No(1)}function Oo(){var r=process.emit;process.emit=function(e){if(e==="uncaughtException"){var t=arguments[1]&&arguments[1].stack,n=this.listeners(e).length>0;if(t&&!n)return Po(arguments[1])}return r.apply(this,arguments)}}var Do=te.slice(0),Mo=re.slice(0);pe.wrapCallSite=ps;pe.getErrorSource=gs;pe.mapSourcePosition=Ar;pe.retrieveSourceMap=Er;pe.install=function(r){if(r=r||{},r.environment&&(qe=r.environment,["node","browser","auto"].indexOf(qe)===-1))throw new Error("environment "+qe+" was unknown. Available options are {auto, browser, node}");if(r.retrieveFile&&(r.overrideRetrieveFile&&(te.length=0),te.unshift(r.retrieveFile)),r.retrieveSourceMap&&(r.overrideRetrieveSourceMap&&(re.length=0),re.unshift(r.retrieveSourceMap)),r.hookRequire&&!Sr()){var e=us(_r,"module"),t=e.prototype._compile;t.__sourceMapSupport||(e.prototype._compile=function(i,o){return fe[o]=i,Be[o]=void 0,t.call(this,i,o)},e.prototype._compile.__sourceMapSupport=!0)}if(yr||(yr="emptyCacheBetweenOperations"in r?r.emptyCacheBetweenOperations:!1),ds||(ds=!0,Error.prepareStackTrace=Lo),!ls){var n="handleUncaughtExceptions"in r?r.handleUncaughtExceptions:!0;try{var s=us(_r,"worker_threads");s.isMainThread===!1&&(n=!1)}catch{}n&&Eo()&&(ls=!0,Oo())}};pe.resetRetrieveHandlers=function(){te.length=0,re.length=0,te=Do.slice(0),re=Mo.slice(0),Er=ft(re),br=ft(te)}});var vs=g(()=>{ms().install()});var ys=g((yu,ws)=>{var be=1e3,Ee=be*60,Ae=Ee*60,ge=Ae*24,Fo=ge*7,ko=ge*365.25;ws.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return xo(r);if(t==="number"&&isFinite(r))return e.long?qo(r):Uo(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function xo(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\\d+)?\\.?\\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*ko;case"weeks":case"week":case"w":return t*Fo;case"days":case"day":case"d":return t*ge;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Ae;case"minutes":case"minute":case"mins":case"min":case"m":return t*Ee;case"seconds":case"second":case"secs":case"sec":case"s":return t*be;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Uo(r){var e=Math.abs(r);return e>=ge?Math.round(r/ge)+"d":e>=Ae?Math.round(r/Ae)+"h":e>=Ee?Math.round(r/Ee)+"m":e>=be?Math.round(r/be)+"s":r+"ms"}function qo(r){var e=Math.abs(r);return e>=ge?pt(r,e,ge,"day"):e>=Ae?pt(r,e,Ae,"hour"):e>=Ee?pt(r,e,Ee,"minute"):e>=be?pt(r,e,be,"second"):r+" ms"}function pt(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}});var Cr=g((Ru,Rs)=>{function Bo(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=ys(),t.destroy=u,Object.keys(r).forEach(d=>{t[d]=r[d]}),t.names=[],t.skips=[],t.formatters={};function e(d){let l=0;for(let h=0;h<d.length;h++)l=(l<<5)-l+d.charCodeAt(h),l|=0;return t.colors[Math.abs(l)%t.colors.length]}t.selectColor=e;function t(d){let l,h=null,f,v;function m(...R){if(!m.enabled)return;let y=m,E=Number(new Date),rt=E-(l||E);y.diff=rt,y.prev=l,y.curr=E,l=E,R[0]=t.coerce(R[0]),typeof R[0]!="string"&&R.unshift("%O");let nt=0;R[0]=R[0].replace(/%([a-zA-Z%])/g,(er,Fi)=>{if(er==="%%")return"%";nt++;let hn=t.formatters[Fi];if(typeof hn=="function"){let ki=R[nt];er=hn.call(y,ki),R.splice(nt,1),nt--}return er}),t.formatArgs.call(y,R),(y.log||t.log).apply(y,R)}return m.namespace=d,m.useColors=t.useColors(),m.color=t.selectColor(d),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(f!==t.namespaces&&(f=t.namespaces,v=t.enabled(d)),v),set:R=>{h=R}}),typeof t.init=="function"&&t.init(m),m}function n(d,l){let h=t(this.namespace+(typeof l>"u"?":":l)+d);return h.log=this.log,h}function s(d){t.save(d),t.namespaces=d,t.names=[],t.skips=[];let l,h=(typeof d=="string"?d:"").split(/[\\s,]+/),f=h.length;for(l=0;l<f;l++)h[l]&&(d=h[l].replace(/\\*/g,".*?"),d[0]==="-"?t.skips.push(new RegExp("^"+d.slice(1)+"$")):t.names.push(new RegExp("^"+d+"$")))}function i(){let d=[...t.names.map(a),...t.skips.map(a).map(l=>"-"+l)].join(",");return t.enable(""),d}function o(d){if(d[d.length-1]==="*")return!0;let l,h;for(l=0,h=t.skips.length;l<h;l++)if(t.skips[l].test(d))return!1;for(l=0,h=t.names.length;l<h;l++)if(t.names[l].test(d))return!0;return!1}function a(d){return d.toString().substring(2,d.toString().length-2).replace(/\\.\\*\\?$/,"*")}function c(d){return d instanceof Error?d.stack||d.message:d}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Rs.exports=Bo});var _s=g((k,gt)=>{k.formatArgs=Qo;k.save=$o;k.load=Go;k.useColors=jo;k.storage=Wo();k.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();k.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function jo(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\\/(\\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\\/(\\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\\/(\\d+)/)}function Qo(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+gt.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}k.log=console.debug||console.log||(()=>{});function $o(r){try{r?k.storage.setItem("debug",r):k.storage.removeItem("debug")}catch{}}function Go(){let r;try{r=k.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function Wo(){try{return localStorage}catch{}}gt.exports=Cr()(k);var{formatters:Ho}=gt.exports;Ho.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var bs=g((T,vt)=>{var Vo=w("tty"),mt=w("util");T.init=ea;T.log=Xo;T.formatArgs=zo;T.save=Zo;T.load=Jo;T.useColors=Ko;T.destroy=mt.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");T.colors=[6,2,3,4,5,1];try{let r=w("supports-color");r&&(r.stderr||r).level>=2&&(T.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch{}T.inspectOpts=Object.keys(process.env).filter(r=>/^debug_/i.test(r)).reduce((r,e)=>{let t=e.substring(6).toLowerCase().replace(/_([a-z])/g,(s,i)=>i.toUpperCase()),n=process.env[e];return/^(yes|on|true|enabled)$/i.test(n)?n=!0:/^(no|off|false|disabled)$/i.test(n)?n=!1:n==="null"?n=null:n=Number(n),r[t]=n,r},{});function Ko(){return"colors"in T.inspectOpts?!!T.inspectOpts.colors:Vo.isatty(process.stderr.fd)}function zo(r){let{namespace:e,useColors:t}=this;if(t){let n=this.color,s="\\x1B[3"+(n<8?n:"8;5;"+n),i=`  ${s};1m${e} \\x1B[0m`;r[0]=i+r[0].split(`\n`).join(`\n`+i),r.push(s+"m+"+vt.exports.humanize(this.diff)+"\\x1B[0m")}else r[0]=Yo()+e+" "+r[0]}function Yo(){return T.inspectOpts.hideDate?"":new Date().toISOString()+" "}function Xo(...r){return process.stderr.write(mt.formatWithOptions(T.inspectOpts,...r)+`\n`)}function Zo(r){r?process.env.DEBUG=r:delete process.env.DEBUG}function Jo(){return process.env.DEBUG}function ea(r){r.inspectOpts={};let e=Object.keys(T.inspectOpts);for(let t=0;t<e.length;t++)r.inspectOpts[e[t]]=T.inspectOpts[e[t]]}vt.exports=Cr()(T);var{formatters:Ss}=vt.exports;Ss.o=function(r){return this.inspectOpts.colors=this.useColors,mt.inspect(r,this.inspectOpts).split(`\n`).map(e=>e.trim()).join(" ")};Ss.O=function(r){return this.inspectOpts.colors=this.useColors,mt.inspect(r,this.inspectOpts)}});var Z=g((_u,Nr)=>{typeof process>"u"||process.type==="renderer"||process.browser===!0||process.__nwjs?Nr.exports=_s():Nr.exports=bs()});var Es=g((Su,ta)=>{ta.exports={name:"@homebridge/ciao",version:"1.3.1",description:"ciao is a RFC 6763 compliant dns-sd library, advertising on multicast dns (RFC 6762) implemented in plain Typescript/JavaScript",main:"lib/index.js",types:"lib/index.d.ts",maintainers:["Andreas Bauer <mail@anderl-bauer.de>"],author:"Andreas Bauer <mail@anderl-bauer.de>",homepage:"https://github.com/homebridge/ciao",license:"MIT",scripts:{clean:"rimraf lib && rimraf coverage",lint:"eslint \'src/**/*.{js,ts,json}\'","lint-docs":"typedoc --emit none",build:"npm run clean && tsc",test:"jest","test-coverage":"jest --coverage",docs:"typedoc",prepublishOnly:"npm run build",postpublish:"npm run clean",preversion:"npm run lint",version:"npm run docs && git add docs"},bin:{"ciao-bcs":"lib/bonjour-conformance-testing.js"},keywords:["ciao","rfc-6762","rfc-6763","multicast-dns","dns-sd","bonjour","zeroconf","zero-configuration","mdns","mdns-sd","service-discovery"],repository:{type:"git",url:"git+https://github.com/homebridge/ciao.git"},bugs:{url:"https://github.com/homebridge/ciao/issues"},engines:{node:"^18 || ^20 || ^22"},files:["lib","types","README.md","LICENSE","package.json"],dependencies:{debug:"^4.3.6","fast-deep-equal":"^3.1.3","source-map-support":"^0.5.21",tslib:"^2.6.3"},devDependencies:{"@types/debug":"^4.1.12","@types/jest":"^29.5.12","@types/node":"^22.1.0","@types/source-map-support":"^0.5.10","@typescript-eslint/eslint-plugin":"^8.0.1","@typescript-eslint/parser":"^8.0.1",eslint:"^8.57.0",jest:"^29.7.0",rimraf:"^6.0.1","ts-jest":"^29.2.4","ts-node":"^10.9.2",typedoc:"^0.26.5",typescript:"^5.5.4"}}});var ne=g(Ir=>{"use strict";Object.defineProperty(Ir,"__esModule",{value:!0});Ir.dnsLowerCase=na;var ra=/[A-Z]/g;function na(r){return r.replace(ra,e=>e.toLowerCase())}});var Lr=g(Tr=>{"use strict";Object.defineProperty(Tr,"__esModule",{value:!0});Tr.dnsTypeToString=sa;function sa(r){switch(r){case 1:return"A";case 5:return"CNAME";case 12:return"PTR";case 16:return"TXT";case 28:return"AAAA";case 33:return"SRV";case 41:return"OPT";case 47:return"NSEC";case 255:return"ANY"}return"UNSUPPORTED_"+r}});var Pr=g(Ce=>{"use strict";Object.defineProperty(Ce,"__esModule",{value:!0});Ce.NonCompressionLabelCoder=Ce.DNSLabelCoder=void 0;var ia=(N(),A(C)),b=ia.__importDefault(w("assert")),W=class r{constructor(e){this.trackedLengths=[],this.writtenNames=[],this.legacyUnicastEncoding=e||!1}initBuf(e){this.buffer=e}initRRLocation(e,t,n){this.startOfRR=e,this.startOfRData=t,this.rDataLength=n}clearRRLocation(){this.startOfRR=void 0,this.startOfRData=void 0,this.rDataLength=void 0}getUncompressedNameLength(e){if(e===".")return 1;(0,b.default)(e.endsWith("."),"Supplied illegal name which doesn\'t end with the root label!");let t=0,n=e.split(".");for(let s=0;s<n.length;s++){let i=n[s];!i&&s<n.length-1&&b.default.fail("Label "+s+" in name \'"+e+"\' was empty"),t+=r.getLabelLength(i)}return t}getNameLength(e){if(r.DISABLE_COMPRESSION)return this.getUncompressedNameLength(e);if(e===".")return 1;(0,b.default)(e.endsWith("."),"Supplied illegal name which doesn\'t end with the root label!");let t=e.split(".").map(a=>r.getLabelLength(a)),n={name:e,length:0,labelLengths:t},s,i=0;for(let a=0;a<this.trackedLengths.length;a++){let c=this.trackedLengths[a],u=r.computeLabelSuffixLength(c.name,e);u>i&&(s=c,i=u)}let o=0;if(s){let a=t.length-1-i;for(let c=0;c<a;c++)o+=t[c];o+=2}else for(let a=0;a<t.length;a++)o+=t[a];return n.length=o,this.trackedLengths.push(n),n.length}encodeUncompressedName(e,t){return this.buffer||b.default.fail("Illegal state. Buffer not initialized!"),r.encodeUncompressedName(e,this.buffer,t)}static encodeUncompressedName(e,t,n){(0,b.default)(e.endsWith("."),"Name does not end with the root label");let s=n,i=e==="."?[""]:e.split(".");for(let o=0;o<i.length;o++){let a=i[o];if(a===""){(0,b.default)(o===i.length-1,"Encountered root label being not at the end of the domain name"),t.writeUInt8(0,n++);break}let c=t.write(a,n+1);t.writeUInt8(c,n),n+=c+1}return n-s}encodeName(e,t){if(r.DISABLE_COMPRESSION)return this.encodeUncompressedName(e,t);if(this.buffer||b.default.fail("Illegal state. Buffer not initialized!"),e===".")return this.buffer.writeUInt8(0,t),1;let n=t,s=e.split("."),i={name:e,writtenLabels:new Array(s.length).fill(-1)},o,a=0;for(let c=0;c<this.writtenNames.length;c++){let u=this.writtenNames[c],d=r.computeLabelSuffixLength(u.name,e);d>a&&(o=u,a=d)}if(o){let c=s.length-1-a,u=o.writtenLabels.length-1-a;for(let h=0;h<c;h++)i.writtenLabels[h]=t,t+=r.writeLabel(s[h],this.buffer,t);let d=o.writtenLabels[u];(0,b.default)(d!==-1,"Label which was pointed at wasn\'t yet written to the buffer!"),(0,b.default)(d<=r.NOT_POINTER_MASK,"Pointer exceeds to length of a maximum of 14 bits"),(0,b.default)(d<t,"Pointer can only point to a prior location");let l=r.POINTER_MASK|d;this.buffer.writeUInt16BE(l,t),t+=2}else for(let c=0;c<s.length;c++)i.writtenLabels[c]=t,t+=r.writeLabel(s[c],this.buffer,t);return this.writtenNames.push(i),t-n}decodeName(e,t=!0){this.buffer||b.default.fail("Illegal state. Buffer not initialized!");let n=e,s="";for(;;){let i=this.buffer.readUInt8(e++);if(i===0){s+=".";break}let o=i&r.POINTER_MASK_ONE_BYTE;if(o)if(o===r.POINTER_MASK_ONE_BYTE){let c=this.buffer.readUInt16BE(e-1)&r.NOT_POINTER_MASK;if(e++,!t){s+=s?".~":"~";break}(0,b.default)(c<n,"Pointer at "+(e-2)+" MUST point to a prior location!"),s+=(s?".":"")+this.decodeName(c).data;break}else if(o===r.LOCAL_COMPRESSION_ONE_BYTE){let c=this.buffer.readUInt16BE(e-1)&r.NOT_POINTER_MASK;if(e++,!t){s+=s?".~":"~";break}c>=0&&c<255?((0,b.default)(this.startOfRR!==void 0,"Cannot decompress locally compressed name as record is not initialized!"),c+=this.startOfRR,(0,b.default)(c<n,"LocalPointer <255 at "+(e-2)+" MUST point to a prior location!"),s+=(s?".":"")+this.decodeName(c).data):c>=256?((0,b.default)(this.startOfRData!==void 0&&this.rDataLength!==void 0,"Cannot decompress locally compressed name as record is not initialized!"),c-=-256,c+=this.startOfRData,(0,b.default)(c<n,"LocationPoint >265 at "+(e+2)+" MUST point to a prior location!"),s+=(s?".":"")+this.decodeName(c).data):b.default.fail("Encountered unknown pointer range "+c);break}else if(o===r.EXTENDED_LABEL_TYPE_ONE_BYTE){let c=i&r.NOT_POINTER_MASK_ONE_BYTE;b.default.fail("Received extended label type "+c+" at "+(e-1))}else b.default.fail("Encountered unknown pointer type: "+Buffer.from([o>>6]).toString("hex")+" (with original byte "+Buffer.from([i]).toString("hex")+")");let a=this.buffer.toString("utf-8",e,e+i);e+=i,s+=(s?".":"")+a}return{data:s,readBytes:e-n}}static getLabelLength(e){if(e){let t=Buffer.byteLength(e);return(0,b.default)(t<=63,"Label cannot be longer than 63 bytes ("+e+")"),1+t}else return 1}static writeLabel(e,t,n){if(e){let s=t.write(e,n+1);return t.writeUInt8(s,n),s+1}else return t.writeUInt8(0,n),1}static computeLabelSuffixLength(e,t){(0,b.default)(e.length!==0&&t.length!==0,"Encountered empty name when comparing suffixes!");let n=e.length-1,s=t.length-1,i=0,o=!1;for(let a=1;a<=n&&a<=s;a++){let c=e.charAt(n-a),u=t.charAt(s-a);if((0,b.default)(!!c&&!!u,"Seemingly encountered out of bounds trying to calculate suffixes"),c!==u){o=!0;break}else c==="."&&i++}return o||i++,i}};Ce.DNSLabelCoder=W;W.DISABLE_COMPRESSION=!1;W.POINTER_MASK=49152;W.POINTER_MASK_ONE_BYTE=192;W.LOCAL_COMPRESSION_ONE_BYTE=128;W.EXTENDED_LABEL_TYPE_ONE_BYTE=64;W.NOT_POINTER_MASK=16383;W.NOT_POINTER_MASK_ONE_BYTE=63;var je=class extends W{getNameLength(e){return this.getUncompressedNameLength(e)}encodeName(e,t){return this.encodeUncompressedName(e,t)}};Ce.NonCompressionLabelCoder=je;je.INSTANCE=new je});var B=g(wt=>{"use strict";Object.defineProperty(wt,"__esModule",{value:!0});wt.ResourceRecord=void 0;var As=(N(),A(C)),oa=As.__importDefault(w("assert")),aa=As.__importDefault(Z()),ca=ne(),ua=Lr(),da=Pr(),la=(0,aa.default)("ciao:decoder"),se=class r{constructor(e,t,n=r.RR_DEFAULT_TTL,s=!1,i=1){this.flushFlag=!1,typeof e=="string"?(e.endsWith(".")||(e=e+"."),this.name=e,this.type=t,this.class=i,this.ttl=n,this.flushFlag=s):(this.name=e.name,this.type=e.type,this.class=e.class,this.ttl=e.ttl,this.flushFlag=e.flushFlag)}getLowerCasedName(){return this.lowerCasedName||(this.lowerCasedName=(0,ca.dnsLowerCase)(this.name))}getEncodingLength(e){return e.getNameLength(this.name)+10+this.getRDataEncodingLength(e)}encode(e,t,n){let s=n,i=e.encodeName(this.name,n);n+=i,t.writeUInt16BE(this.type,n),n+=2;let o=this.class;this.flushFlag&&(o|=r.FLUSH_MASK),t.writeUInt16BE(o,n),n+=2,t.writeUInt32BE(this.ttl,n),n+=4;let a=this.encodeRData(e,t,n+2);return t.writeUInt16BE(a,n),n+=2+a,n-s}getRawData(){let e=da.NonCompressionLabelCoder.INSTANCE,t=this.getRDataEncodingLength(e),n=Buffer.allocUnsafe(t);e.initBuf(n);let s=this.encodeRData(e,n,0);return(0,oa.default)(s===n.length,"Didn\'t completely write to the buffer! ("+s+"!="+n.length+")"),e.initBuf(),n}static clone(e){return e.map(t=>t.clone())}getRecordRepresentation(){return{name:this.name,type:this.type,class:this.class,ttl:this.ttl,flushFlag:this.flushFlag}}aboutEqual(e){return this.type===e.type&&this.name===e.name&&this.class===e.class&&this.dataEquals(e)}representsSameData(e){return this.type===e.type&&this.name===e.name&&this.class===e.class}asString(){return`RR ${this.name} ${this.type} ${this.class} ${this.dataAsString()}`}static decode(e,t,n,s){let i=s,o=this.decodeRecordHeader(t,n,s);s+=o.readBytes;let a=o.data,c=this.typeToRecordDecoder.get(a.type);if(!c)return{readBytes:s+a.rDataLength-i};t.initRRLocation(i,s,a.rDataLength);let u=n.subarray(0,s+a.rDataLength),d;try{d=c(t,a,u,s)}catch(l){return la(`Received malformed rdata section for ${(0,ua.dnsTypeToString)(a.type)} ${a.name} ${a.ttl} from ${e.address}:${e.port} with data \'${u.subarray(s).toString("hex")}\': ${l.stack}`),{readBytes:s+a.rDataLength-i}}return s+=d.readBytes,t.clearRRLocation(),{data:d.data,readBytes:s-i}}static decodeRecordHeader(e,t,n){let s=n,i=e.decodeName(n);n+=i.readBytes;let o=t.readUInt16BE(n);n+=2;let a=t.readUInt16BE(n);n+=2;let c,u=!1;o!==41?(c=a&this.NOT_FLUSH_MASK,u=!!(a&this.FLUSH_MASK)):c=a;let d=t.readUInt32BE(n);n+=4;let l=t.readUInt16BE(n);return n+=2,{data:{name:i.data,type:o,class:c,ttl:d,flushFlag:u,rDataLength:l},readBytes:n-s}}};wt.ResourceRecord=se;se.typeToRecordDecoder=new Map;se.FLUSH_MASK=32768;se.NOT_FLUSH_MASK=32767;se.RR_DEFAULT_TTL_SHORT=120;se.RR_DEFAULT_TTL=4500});var Cs=g(yt=>{"use strict";Object.defineProperty(yt,"__esModule",{value:!0});yt.isIPv4Mapped=ha;yt.getIPFromV4Mapped=fa;function ha(r){var e;if(!/^::ffff:(\\d{1,3}\\.){3}\\d{1,3}$/i.test(r))return!1;let t=(e=r.split(/::ffff:/i)[1])===null||e===void 0?void 0:e.split(".").map(Number);return t?.length===4&&t.every(n=>n>=0&&n<=255)}function fa(r){var e;return(e=r.split(/^::ffff:/i)[1])!==null&&e!==void 0?e:null}});var Ne=g(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.parseFQDN=va;Q.stringify=wa;Q.formatHostname=ya;Q.removeTLD=Ra;Q.formatMappedIPv4Address=_a;Q.enlargeIPv6=$e;Q.shortenIPv6=Dr;Q.formatReverseAddressPTRName=Sa;Q.ipAddressFromReversAddressName=ba;Q.getNetAddress=Ea;var Ns=(N(),A(C)),j=Ns.__importDefault(w("assert")),J=Ns.__importDefault(w("net")),Or=Cs();function pa(r){return r==="_tcp"||r==="_udp"}function ga(r){return r==="_sub"}function Qe(r){return r.startsWith("_")?r.slice(1):r}function ma(r){return"subtype"in r}function va(r){let e=r.split(".");(0,j.default)(e.length>=3,"Received illegal fqdn: "+r);let t=e.length-1,n="";for(;!pa(e[t]);)n=Qe(e[t])+(n?"."+n:""),t--;(0,j.default)(t>=1,"Failed to parse illegal fqdn: "+r);let s=Qe(e[t--]),i=Qe(e[t--]);if(t<0)return{domain:n,protocol:s,type:i};if(ga(e[t])){t--,(0,j.default)(t===0,"Received illegal formatted sub type fqdn: "+r);let o=Qe(e[t]);return{domain:n,protocol:s,type:i,subtype:o}}else{let o=Qe(e.slice(0,t+1).join("."));return{domain:n,protocol:s,type:i,name:o}}}function wa(r){(0,j.default)(r.type,"type cannot be undefined"),(0,j.default)(r.type.length<=15,"type must not be longer than 15 characters");let e;return ma(r)?e=`_${r.subtype}._sub.`:e=r.name?`${r.name}.`:"",`${e}_${r.type}._${r.protocol||"tcp"}.${r.domain||"local"}.`}function ya(r,e="local"){(0,j.default)(!r.endsWith("."),"hostname must not end with the root label!");let t="."+e;return(r.endsWith(t)?r:r+t)+"."}function Ra(r){r.endsWith(".")&&(r=r.substring(0,r.length-1));let e=r.lastIndexOf(".");return r.slice(0,e)}function _a(r){return(0,Or.isIPv4Mapped)(r)||(0,j.default)(J.default.isIPv4(r),"Illegal argument. Must be an IPv4 address!"),(0,j.default)(J.default.isIPv4(r),"Illegal argument. Must be an IPv4 address!"),`::ffff:${r.split(".").map(n=>parseInt(n).toString(16).padStart(2,"0")).join("")}`.replace(/(.{4})(.{4})$/,"$1:$2")}function $e(r){(0,j.default)(J.default.isIPv6(r),"Illegal argument. Must be ipv6 address!");let e=r.split("::"),t=e[0]?e[0].split(":"):[],n=e[1]?e[1].split(":"):[],s=new Array(8-t.length-n.length).fill("0000");return[...t,...s,...n].map(i=>i.padStart(4,"0")).join(":")}function Dr(r){typeof r=="string"&&(r=r.split(":"));for(let s=0;s<r.length;s++){let i=r[s],o=0;for(;o<Math.min(3,i.length-1)&&i.charAt(o)==="0";o++);r[s]=i.substr(o)}let e=-1,t=0;for(let s=0;s<r.length;s++){if(r[s]!=="0")continue;let i=1,o=s+1;for(;o<r.length&&r[o]==="0";o++)i++;i>t&&(e=s,t=i),s=o}if(e!==-1){let s=e===0||e+t===8;r[e]=s?":":"",t>1&&r.splice(e+1,t-1)}let n=r.join(":");return n===":"?"::":n}function Sa(r){if(J.default.isIPv4(r))return r.split(".").reverse().join(".")+".in-addr.arpa";if(!J.default.isIPv6(r))throw new Error("Supplied illegal ip address format: "+r);if((0,Or.isIPv4Mapped)(r))return(0,Or.getIPFromV4Mapped)(r).split(".").reverse().join(".")+".in-addr.arpa";r=$e(r).toUpperCase();let e=r.replace(/:/g,"").split("").reverse();return(0,j.default)(e.length===32,"Encountered invalid ipv6 address length! "+e.length),e.join(".")+".ip6.arpa"}function ba(r){if(r=r.toLowerCase(),r.endsWith(".in-addr.arpa"))return r.replace(".in-addr.arpa","").split(".").reverse().join(".");if(r.endsWith(".ip6.arpa")){let e=r.replace(".ip6.arpa","").split(".").reverse();(0,j.default)(e.length===32,"Encountered illegal length for .ip6.arpa split!");let t=[];for(let n=0;n<e.length;n+=4)t.push(e.slice(n,n+4).join(""));return Dr(t.join(":"))}else throw new Error("Supplied unknown reverse address name format: "+r)}function Ea(r,e){if((0,j.default)(J.default.isIP(r)===J.default.isIP(e),"IP address version must match. Netmask cannot have a version different from the address!"),J.default.isIPv4(r)){let t=r.split("."),n=e.split("."),s=new Array(4);for(let i=0;i<t.length;i++){let o=parseInt(t[i]),a=parseInt(n[i]);s[i]=(o&a).toString()}return s.join(".")}else if(J.default.isIPv6(r)){let t=$e(r).split(":"),n=$e(e).split(":"),s=new Array(8);for(let i=0;i<t.length;i++){let o=parseInt(t[i],16),a=parseInt(n[i],16);s[i]=(o&a).toString(16)}return Dr($e(s.join(":")))}else throw new Error("Illegal argument. Address is not an ip address!")}});var _t=g(Rt=>{"use strict";Object.defineProperty(Rt,"__esModule",{value:!0});Rt.AAAARecord=void 0;var Ts=(N(),A(C)),Mr=Ts.__importDefault(w("assert")),Aa=Ts.__importDefault(w("net")),Is=Ne(),Ca=B(),Ge=class r extends Ca.ResourceRecord{constructor(e,t,n,s){typeof e=="string"?super(e,28,s||r.DEFAULT_TTL,n):((0,Mr.default)(e.type===28),super(e)),(0,Mr.default)(Aa.default.isIPv6(t),"IP address is not in v6 format!"),this.ipAddress=t}getRDataEncodingLength(){return 16}encodeRData(e,t,n){let s=n,o=(0,Is.enlargeIPv6)(this.ipAddress).split(":");(0,Mr.default)(o.length===8,"invalid IP address");for(let a of o){let c=parseInt(a,16);t.writeUInt16BE(c,n),n+=2}return n-s}static decodeData(e,t,n,s){let i=s,o=new Array(8);for(let c=0;c<8;c++){let u=n.readUInt16BE(s);s+=2,o[c]=u.toString(16)}let a=(0,Is.shortenIPv6)(o.join(":"));return{data:new r(t,a),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.ipAddress)}dataAsString(){return this.ipAddress}dataEquals(e){return this.ipAddress===e.ipAddress}};Rt.AAAARecord=Ge;Ge.DEFAULT_TTL=Ge.RR_DEFAULT_TTL_SHORT});var bt=g(St=>{"use strict";Object.defineProperty(St,"__esModule",{value:!0});St.ARecord=void 0;var Ls=(N(),A(C)),Fr=Ls.__importDefault(w("assert")),Na=Ls.__importDefault(w("net")),Ia=B(),We=class r extends Ia.ResourceRecord{constructor(e,t,n,s){typeof e=="string"?super(e,1,s||r.DEFAULT_TTL,n):((0,Fr.default)(e.type===1),super(e)),(0,Fr.default)(Na.default.isIPv4(t),"IP address is not in IPv4 format!"),this.ipAddress=t}getRDataEncodingLength(){return 4}encodeRData(e,t,n){let s=n,i=this.ipAddress.split(".");(0,Fr.default)(i.length===4,"invalid ip address");for(let o of i){let a=parseInt(o,10);t.writeUInt8(a,n++)}return n-s}static decodeData(e,t,n,s){let i=s,o=new Array(4);for(let c=0;c<4;c++){let u=n.readUInt8(s++);o[c]=u.toString(10)}let a=o.join(".");return{data:new r(t,a),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.ipAddress)}dataAsString(){return this.ipAddress}dataEquals(e){return this.ipAddress===e.ipAddress}};St.ARecord=We;We.DEFAULT_TTL=We.RR_DEFAULT_TTL_SHORT});var Os=g(At=>{"use strict";Object.defineProperty(At,"__esModule",{value:!0});At.CNAMERecord=void 0;var Ta=(N(),A(C)),La=Ta.__importDefault(w("assert")),Pa=ne(),Ps=B(),Et=class r extends Ps.ResourceRecord{constructor(e,t,n,s){typeof e=="string"?super(e,5,s,n):((0,La.default)(e.type===5),super(e)),t.endsWith(".")||(t+="."),this.cname=t}getLowerCasedCName(){return this.lowerCasedCName||(this.lowerCasedCName=(0,Pa.dnsLowerCase)(this.cname))}getRDataEncodingLength(e){return e.getNameLength(this.cname)}encodeRData(e,t,n){let s=n,i=e.encodeName(this.cname,n);return n+=i,n-s}static decodeData(e,t,n,s){let i=s,o=e.decodeName(s);return s+=o.readBytes,{data:new r(t,o.data),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.cname)}dataAsString(){return this.cname}dataEquals(e){return this.getLowerCasedCName()===e.getLowerCasedCName()}};At.CNAMERecord=Et;Et.DEFAULT_TTL=Ps.ResourceRecord.RR_DEFAULT_TTL});var He=g((Ou,Ds)=>{"use strict";Ds.exports=function r(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var n,s,i;if(Array.isArray(e)){if(n=e.length,n!=t.length)return!1;for(s=n;s--!==0;)if(!r(e[s],t[s]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(i=Object.keys(e),n=i.length,n!==Object.keys(t).length)return!1;for(s=n;s--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[s]))return!1;for(s=n;s--!==0;){var o=i[s];if(!r(e[o],t[o]))return!1}return!0}return e!==e&&t!==t}});var xr=g(Ct=>{"use strict";Object.defineProperty(Ct,"__esModule",{value:!0});Ct.NSECRecord=void 0;var Fs=(N(),A(C)),Ms=Fs.__importDefault(w("assert")),Oa=Fs.__importDefault(He()),Da=ne(),Ma=B(),kr=class r extends Ma.ResourceRecord{constructor(e,t,n,s,i){typeof e=="string"?super(e,47,s||r.RR_DEFAULT_TTL_SHORT,i):((0,Ms.default)(e.type===47),super(e)),t.endsWith(".")||(t+="."),this.nextDomainName=t,this.rrTypeWindows=r.rrTypesToWindowMap(n)}getLowerCasedNextDomainName(){return this.lowerCasedNextDomainName||(this.lowerCasedNextDomainName=(0,Da.dnsLowerCase)(this.nextDomainName))}getRRTypesBitMapEncodingLength(){let e=0;for(let t of this.rrTypeWindows)(0,Ms.default)(t.rrtypes.length>0,"types array for windowId "+t.windowId+" cannot be empty!"),e+=2+t.bitMapSize;return e}getRDataEncodingLength(e){return(e.legacyUnicastEncoding?e.getUncompressedNameLength(this.nextDomainName):e.getUncompressedNameLength(this.nextDomainName))+this.getRRTypesBitMapEncodingLength()}encodeRData(e,t,n){let s=n,i=e.legacyUnicastEncoding?e.encodeUncompressedName(this.nextDomainName,n):e.encodeUncompressedName(this.nextDomainName,n);n+=i;for(let o of this.rrTypeWindows){t.writeUInt8(o.windowId,n++),t.writeUInt8(o.bitMapSize,n++);let a=Buffer.alloc(o.bitMapSize);for(let c of o.rrtypes){let u=(c&255)>>3,d=a.readUInt8(u);d|=1<<7-(c&7),a.writeUInt8(d,u)}a.copy(t,n),n+=a.length}return n-s}static decodeData(e,t,n,s){let i=s,o=e.decodeName(s,!1);s+=o.readBytes;let a=[];for(;s<n.length;){let c=n.readUInt8(s++),u=n.readUInt8(s++),d=c<<8;for(let l=0;l<u;l++){let h=n.readUInt8(s++);for(let f=0;f<8;f++)if(h&1<<7-f){let v=d|l<<3|f;a.push(v)}}}return{data:new r(t,o.data,a),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.nextDomainName,r.windowsToRRTypes(this.rrTypeWindows))}dataAsString(){return`${this.nextDomainName} [${r.windowsToRRTypes(this.rrTypeWindows).map(e=>""+e).join(",")}]`}dataEquals(e){return this.getLowerCasedNextDomainName()===e.getLowerCasedNextDomainName()&&(0,Oa.default)(this.rrTypeWindows,e.rrTypeWindows)}static rrTypesToWindowMap(e){let t=[];for(let n of e){let s=n>>8,i;for(let o of t)if(o.windowId===s){i=o;break}if(!i)i={windowId:s,bitMapSize:Math.ceil((n&255)/8),rrtypes:[n]},t.push(i);else{i.rrtypes.push(n);let o=Math.ceil((n&255)/8);o>i.bitMapSize&&(i.bitMapSize=o)}}return t.sort((n,s)=>n.windowId-s.windowId),t.forEach(n=>n.rrtypes.sort((s,i)=>s-i)),t}static windowsToRRTypes(e){let t=[];for(let n of e)t.push(...n.rrtypes);return t}};Ct.NSECRecord=kr});var xs=g(Nt=>{"use strict";Object.defineProperty(Nt,"__esModule",{value:!0});Nt.OPTRecord=void 0;var ks=(N(),A(C)),Fa=ks.__importDefault(w("assert")),ka=ks.__importDefault(He()),xa=B(),Ie=class r extends xa.ResourceRecord{constructor(e,t,n,s,i,o){typeof e=="number"?(super(".",41,o,!1,e),this.udpPayloadSize=e):((0,Fa.default)(e.type===41),super(e),this.udpPayloadSize=e.class),this.extendedRCode=n||0,this.ednsVersion=i||r.EDNS_VERSION,this.flags={dnsSecOK:s?.dnsSecOK||!1,zero:s?.zero||0,...s},this.options=t||[]}getRDataEncodingLength(){let e=0;for(let t of this.options)e+=2+2+t.data.length;return e}encodeRData(e,t,n){let s=n,i=n-8,o=n-6;t.writeUInt16BE(this.udpPayloadSize,i),t.writeUInt8(this.extendedRCode,o),t.writeUInt8(this.ednsVersion,o+1);let a=this.flags.zero||0;this.flags.dnsSecOK&&(a|=r.DNS_SEC_OK_MASK),t.writeUInt16BE(a,o+2);for(let c of this.options)t.writeUInt16BE(c.code,n),n+=2,t.writeUInt16BE(c.data.length,n),n+=2,c.data.copy(t,n),n+=c.data.length;return n-s}static decodeData(e,t,n,s){let i=s,o=s-8,a=s-6,c=n.readUInt16BE(o),u=n.readUInt8(a),d=n.readUInt8(a+1),l=n.readUInt16BE(a+2),h={dnsSecOK:!!(l&r.DNS_SEC_OK_MASK),zero:l&r.NOT_DNS_SEC_OK_MASK},f=[];for(;s<n.length;){let v=n.readUInt16BE(s);s+=2;let m=n.readUInt16BE(s);s+=2;let R=n.subarray(s,s+m);s+=m,f.push({code:v,data:R})}return t.class=c,t.ttl=4500,{data:new r(t,f,u,h,d),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.options,this.extendedRCode,this.flags,this.ednsVersion)}dataAsString(){return`${this.udpPayloadSize} ${this.extendedRCode} ${this.ednsVersion} ${JSON.stringify(this.flags)} [${this.options.map(e=>`${e.code} ${e.data.toString("base64")}`).join(",")}]`}dataEquals(e){return this.udpPayloadSize===e.udpPayloadSize&&this.extendedRCode===e.extendedRCode&&this.ednsVersion===e.ednsVersion&&r.optionsEquality(this.options,e.options)&&(0,ka.default)(this.flags,e.flags)}static optionsEquality(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++){if(e[n].code!==t[n].code)return!1;if(e[n].data.toString("hex")!==t[n].data.toString("hex"))return!1}return!0}};Nt.OPTRecord=Ie;Ie.EDNS_VERSION=0;Ie.DNS_SEC_OK_MASK=32768;Ie.NOT_DNS_SEC_OK_MASK=32767});var Lt=g(Tt=>{"use strict";Object.defineProperty(Tt,"__esModule",{value:!0});Tt.PTRRecord=void 0;var Ua=(N(),A(C)),qa=Ua.__importDefault(w("assert")),Ba=ne(),Us=B(),It=class r extends Us.ResourceRecord{constructor(e,t,n,s){typeof e=="string"?super(e,12,s,n):((0,qa.default)(e.type===12),super(e)),t.endsWith(".")||(t+="."),this.ptrName=t}getLowerCasedPTRName(){return this.lowerCasedPtrName||(this.lowerCasedPtrName=(0,Ba.dnsLowerCase)(this.ptrName))}getRDataEncodingLength(e){return e.getNameLength(this.ptrName)}encodeRData(e,t,n){let s=n,i=e.encodeName(this.ptrName,n);return n+=i,n-s}static decodeData(e,t,n,s){let i=s,o=e.decodeName(s);return s+=o.readBytes,{data:new r(t,o.data),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.ptrName)}dataAsString(){return this.ptrName}dataEquals(e){return this.getLowerCasedPTRName()===e.getLowerCasedPTRName()}};Tt.PTRRecord=It;It.DEFAULT_TTL=Us.ResourceRecord.RR_DEFAULT_TTL});var Dt=g(Ot=>{"use strict";Object.defineProperty(Ot,"__esModule",{value:!0});Ot.SRVRecord=void 0;var ja=(N(),A(C)),Qa=ja.__importDefault(w("assert")),$a=ne(),Ga=B(),Pt=class r extends Ga.ResourceRecord{constructor(e,t,n,s,i){typeof e=="string"?super(e,33,i||r.RR_DEFAULT_TTL_SHORT,s):((0,Qa.default)(e.type===33),super(e)),t.endsWith(".")?this.hostname=t:this.hostname=t+".",this.port=n,this.priority=0,this.weight=0}getLowerCasedHostname(){return this.lowerCasedHostname||(this.lowerCasedHostname=(0,$a.dnsLowerCase)(this.hostname))}getRDataEncodingLength(e){return 6+(e.legacyUnicastEncoding?e.getUncompressedNameLength(this.hostname):e.getNameLength(this.hostname))}encodeRData(e,t,n){let s=n;t.writeUInt16BE(this.priority,n),n+=2,t.writeUInt16BE(this.weight,n),n+=2,t.writeUInt16BE(this.port,n),n+=2;let i=e.legacyUnicastEncoding?e.encodeUncompressedName(this.hostname,n):e.encodeName(this.hostname,n);return n+=i,n-s}static decodeData(e,t,n,s){let i=s;s+=2,s+=2;let o=n.readUInt16BE(s);s+=2;let a=e.decodeName(s);return s+=a.readBytes,{data:new r(t,a.data,o),readBytes:s-i}}clone(){return new r(this.getRecordRepresentation(),this.hostname,this.port)}dataAsString(){return`${this.hostname} ${this.port} ${this.priority} ${this.weight}`}dataEquals(e){return this.getLowerCasedHostname()===e.getLowerCasedHostname()&&this.port===e.port&&this.weight===e.weight&&this.priority===e.priority}};Ot.SRVRecord=Pt;Pt.DEFAULT_TTL=120});var kt=g(Ft=>{"use strict";Object.defineProperty(Ft,"__esModule",{value:!0});Ft.TXTRecord=void 0;var Wa=(N(),A(C)),qs=Wa.__importDefault(w("assert")),Bs=B(),Mt=class r extends Bs.ResourceRecord{constructor(e,t,n,s){typeof e=="string"?super(e,16,s,n):((0,qs.default)(e.type===16),super(e)),this.txt=t.length===0?[Buffer.from([])]:t}getRDataEncodingLength(){let e=0;for(let t of this.txt)e+=1+t.length,(0,qs.default)(t.length<=255,"One txt character-string can only have a length of 255 chars");return e}encodeRData(e,t,n){let s=n;for(let i of this.txt)t.writeUInt8(i.length,n++),i.copy(t,n),n+=i.length;return n-s}clone(){return new r(this.getRecordRepresentation(),this.txt)}dataAsString(){return`[${this.txt.map(e=>`${e.toString("base64")}`).join(",")}]`}dataEquals(e){if(this.txt.length!==e.txt.length)return!1;for(let t=0;t<this.txt.length;t++)if(this.txt[t].toString("hex")!==e.txt[t].toString("hex"))return!1;return!0}static decodeData(e,t,n,s){let i=s,o=[];for(;s<n.length;){let a=n.readUInt8(s++);o.push(n.subarray(s,s+a)),s+=a}return{data:new r(t,o),readBytes:s-i}}};Ft.TXTRecord=Mt;Mt.DEFAULT_TTL=Bs.ResourceRecord.RR_DEFAULT_TTL});var Ur=g(js=>{"use strict";Object.defineProperty(js,"__esModule",{value:!0});var ie=B(),Ha=_t(),Va=bt(),Ka=Os(),za=xr(),Ya=xs(),Xa=Lt(),Za=Dt(),Ja=kt();ie.ResourceRecord.typeToRecordDecoder.set(28,Ha.AAAARecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(1,Va.ARecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(5,Ka.CNAMERecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(47,za.NSECRecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(12,Xa.PTRRecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(33,Za.SRVRecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(41,Ya.OPTRecord.decodeData);ie.ResourceRecord.typeToRecordDecoder.set(16,Ja.TXTRecord.decodeData)});var Br=g(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});Y.NetworkManager=Y.NetworkManagerEvent=Y.WifiState=Y.IPFamily=void 0;var Pe=(N(),A(C)),qr=Pe.__importDefault(w("assert")),Te=Pe.__importDefault(w("child_process")),ec=Pe.__importDefault(Z()),tc=w("events"),rc=Pe.__importDefault(He()),nc=Pe.__importDefault(w("net")),O=Pe.__importDefault(w("os")),sc=Ne(),x=(0,ec.default)("ciao:NetworkManager"),Qs;(function(r){r.IPv4="IPv4",r.IPv6="IPv6"})(Qs||(Y.IPFamily=Qs={}));var $s;(function(r){r[r.UNDEFINED=0]="UNDEFINED",r[r.NOT_A_WIFI_INTERFACE=1]="NOT_A_WIFI_INTERFACE",r[r.NOT_ASSOCIATED=2]="NOT_ASSOCIATED",r[r.CONNECTED=3]="CONNECTED"})($s||(Y.WifiState=$s={}));var Gs;(function(r){r.NETWORK_UPDATE="network-update"})(Gs||(Y.NetworkManagerEvent=Gs={}));var Le=class r extends tc.EventEmitter{constructor(e){if(super(),this.currentInterfaces=new Map,this.loopbackInterfaces=new Map,this.setMaxListeners(100),e&&e.interface){let t;if(typeof e.interface=="string")t=[e.interface];else if(Array.isArray(e.interface))t=e.interface;else throw new Error("Found invalid type for \'interfaces\' NetworkManager option!");let n=[];for(let s of t)if(nc.default.isIP(s)){let i=r.resolveInterface(s);i?n.push(i):console.log("CIAO: Interface was specified as ip (%s), though couldn\'t find a matching interface for the given address.",e.interface)}else n.push(s);n.length===0?console.log("CIAO: \'restrictedInterfaces\' array was empty. Going to fallback to bind on all available interfaces."):this.restrictedInterfaces=n}this.excludeIpv6=!!(e&&e.excludeIpv6),this.excludeIpv6Only=this.excludeIpv6||!!(e&&e.excludeIpv6Only),e&&x("Created NetworkManager with options: %s",JSON.stringify(e)),this.initPromise=new Promise(t=>{this.getCurrentNetworkInterfaces().then(n=>{this.currentInterfaces=n;let s=Object.keys(O.default.networkInterfaces()),i=[];for(let o of this.currentInterfaces.keys()){i.push(o);let a=s.indexOf(o);a!==-1&&s.splice(a,1)}x("Initial networks [%s] ignoring [%s]",i.join(", "),s.join(", ")),this.initPromise=void 0,t(),this.scheduleNextJob()})})}async waitForInit(){this.initPromise&&await this.initPromise}shutdown(){this.currentTimer&&(clearTimeout(this.currentTimer),this.currentTimer=void 0),this.removeAllListeners()}getInterfaceMap(){return this.initPromise&&qr.default.fail("Not yet initialized!"),this.currentInterfaces}getInterface(e){return this.initPromise&&qr.default.fail("Not yet initialized!"),this.currentInterfaces.get(e)}isLoopbackNetaddressV4(e){for(let t of this.loopbackInterfaces.values())if(t.ipv4Netaddress===e)return!0;return!1}scheduleNextJob(){this.currentTimer=setTimeout(this.checkForNewInterfaces.bind(this),r.POLLING_TIME),this.currentTimer.unref()}async checkForNewInterfaces(){let e=await this.getCurrentNetworkInterfaces();if(!this.currentTimer)return;let t,n,s;for(let[i,o]of e){let a=this.currentInterfaces.get(i);if(a){if(!(0,rc.default)(a,o)){let c={name:i};a.ipv4!==o.ipv4&&(a.ipv4&&(c.outdatedIpv4=a.ipv4),o.ipv4&&(c.updatedIpv4=o.ipv4)),a.ipv6!==o.ipv6&&(a.ipv6&&(c.outdatedIpv6=a.ipv6),o.ipv6&&(c.updatedIpv6=o.ipv6)),a.globallyRoutableIpv6!==o.globallyRoutableIpv6&&(a.globallyRoutableIpv6&&(c.outdatedGloballyRoutableIpv6=a.globallyRoutableIpv6),o.globallyRoutableIpv6&&(c.updatedGloballyRoutableIpv6=o.globallyRoutableIpv6)),a.uniqueLocalIpv6!==o.uniqueLocalIpv6&&(a.uniqueLocalIpv6&&(c.outdatedUniqueLocalIpv6=a.uniqueLocalIpv6),o.uniqueLocalIpv6&&(c.updatedUniqueLocalIpv6=o.uniqueLocalIpv6)),this.currentInterfaces.set(i,o),o.loopback&&this.loopbackInterfaces.set(i,o),(s??(s=[])).push(c)}}else this.currentInterfaces.set(i,o),o.loopback&&this.currentInterfaces.set(i,o),(t??(t=[])).push(o)}if(this.currentInterfaces.size!==e.size)for(let[i,o]of this.currentInterfaces)e.has(i)||(this.currentInterfaces.delete(i),this.loopbackInterfaces.delete(i),(n??(n=[])).push(o));if(t||n||s){let i=t?t.map(c=>c.name).join(","):"",o=n?n.map(c=>c.name).join(","):"",a=s?s.map(c=>{let u=`{ name: ${c.name} `;return(c.outdatedIpv4||c.updatedIpv4)&&(u+=`, ${c.outdatedIpv4} -> ${c.updatedIpv4} `),(c.outdatedIpv6||c.updatedIpv6)&&(u+=`, ${c.outdatedIpv6} -> ${c.updatedIpv6} `),(c.outdatedGloballyRoutableIpv6||c.updatedGloballyRoutableIpv6)&&(u+=`, ${c.outdatedGloballyRoutableIpv6} -> ${c.updatedGloballyRoutableIpv6} `),(c.outdatedUniqueLocalIpv6||c.updatedUniqueLocalIpv6)&&(u+=`, ${c.outdatedUniqueLocalIpv6} -> ${c.updatedUniqueLocalIpv6} `),u+"}"}).join(","):"";x("Detected network changes: added: [%s], removed: [%s], changes: [%s]!",i,o,a),this.emit("network-update",{added:t,removed:n,changes:s})}this.scheduleNextJob()}async getCurrentNetworkInterfaces(){let e;if(this.restrictedInterfaces){e=this.restrictedInterfaces;let s=r.getLoopbackInterface();e.includes(s)||e.push(s)}else try{e=await r.getNetworkInterfaceNames()}catch(s){x(`WARNING Detecting network interfaces for platform \'${O.default.platform()}\' failed. Trying to assume network interfaces! (${s.message})`),e=r.assumeNetworkInterfaceNames()}let t=new Map,n=O.default.networkInterfaces();for(let s of e){let i=n[s];if(!i)continue;let o,a,c,u,d=!1;for(let h of i){if(h.internal&&(d=!0),(h.family==="IPv4"||h.family===4)&&!o)o=h;else if(h.family==="IPv6"||h.family===6){if(this.excludeIpv6)continue;h.scopeid&&!a?a=h:h.scopeid===0&&(h.address.startsWith("fc")||h.address.startsWith("fd")?u||(u=h):c||(c=h))}if(o&&a&&c&&u)break}if((0,qr.default)(o||a,"Could not find valid addresses for interface \'"+s+"\'"),this.excludeIpv6Only&&!o)continue;let l={name:s,loopback:d,mac:o?.mac||a?.mac};o&&(l.ipv4=o.address,l.ip4Netmask=o.netmask,l.ipv4Netaddress=(0,sc.getNetAddress)(o.address,o.netmask)),a&&(l.ipv6=a.address,l.ipv6Netmask=a.netmask),c&&(l.globallyRoutableIpv6=c.address,l.globallyRoutableIpv6Netmask=c.netmask),u&&(l.uniqueLocalIpv6=u.address,l.uniqueLocalIpv6Netmask=u.netmask),t.set(s,l)}return t}static resolveInterface(e){let t;e:for(let[n,s]of Object.entries(O.default.networkInterfaces()))for(let i of s??[])if(i.address===e){t=n;break e}return t}static async getNetworkInterfaceNames(){let e;switch(O.default.platform()){case"win32":e=r.getWindowsNetworkInterfaces();break;case"linux":{e=r.getLinuxNetworkInterfaces();break}case"darwin":e=r.getDarwinNetworkInterfaces();break;case"freebsd":{e=r.getFreeBSDNetworkInterfaces();break}case"openbsd":case"sunos":{e=r.getOpenBSD_SUNOS_NetworkInterfaces();break}default:return x("Found unsupported platform %s",O.default.platform()),Promise.reject(new Error("unsupported platform!"))}let t;try{t=await e}catch(s){if(s.message!==r.NOTHING_FOUND_MESSAGE)throw s;t=[]}let n=r.getLoopbackInterface();return t.includes(n)||t.unshift(n),e}static assumeNetworkInterfaceNames(){let e=[];return Object.entries(O.default.networkInterfaces()).forEach(([t,n])=>{for(let s of n??[])if(s.internal||s.family==="IPv4"||s.family===4||(s.family==="IPv6"||s.family===6)&&s.scopeid===0){e.includes(t)||e.push(t);break}}),e}static getLoopbackInterface(){for(let[e,t]of Object.entries(O.default.networkInterfaces()))for(let n of t??[])if(n.internal)return e;throw new Error("Could not detect loopback interface!")}static getWindowsNetworkInterfaces(){return new Promise((e,t)=>{Te.default.exec(\'arp -a | findstr /C:"---"\',(n,s)=>{if(n){t(n);return}let i=s.split(O.default.EOL),o=[];for(let c=0;c<i.length-1;c++){let u=i[c].trim().split(" ");u[u.length-3]?o.push(u[u.length-3]):x(`WINDOWS: Failed to read interface name from line ${c}: \'${i[c]}\'`)}let a=[];for(let c of o){let u=r.resolveInterface(c);u?a.includes(u)||a.push(u):x(`WINDOWS: Couldn\'t resolve to an interface name from \'${c}\'`)}a.length?e(a):t(new Error(r.NOTHING_FOUND_MESSAGE))})})}static getDarwinNetworkInterfaces(){return new Promise((e,t)=>{Te.default.exec("arp -a -n -l",async(n,s)=>{if(n){t(n);return}let i=s.split(O.default.EOL),o=[];for(let c=1;c<i.length-1;c++){let u=i[c].trim().split(r.SPACE_PATTERN)[4];if(!u){x(`DARWIN: Failed to read interface name from line ${c}: \'${i[c]}\'`);continue}o.includes(u)||o.push(u)}let a=[];for(let c of o){let u=r.getDarwinWifiNetworkState(c).then(d=>{if(d!==1&&d!==3){let l=o.indexOf(c);l!==-1&&o.splice(l,1)}});a.push(u)}await Promise.all(a),o.length?e(o):t(new Error(r.NOTHING_FOUND_MESSAGE))})})}static getLinuxNetworkInterfaces(){return new Promise((e,t)=>{Te.default.exec("ip neigh show",(n,s)=>{if(n){if(n.message.includes("ip: not found")){x("LINUX: ip was not found on the system. Falling back to assuming network interfaces!"),e(r.assumeNetworkInterfaceNames());return}t(n);return}let i=s.split(O.default.EOL),o=[];for(let a=0;a<i.length-1;a++){let c=i[a].trim().split(r.SPACE_PATTERN),u=0;for(;u<c.length&&c[u]!=="dev";u++);if(u>=c.length){x(`LINUX: Out of bounds when reading interface name from line ${a}: \'${i[a]}\'`);continue}let d=c[u+1];if(!d){x(`LINUX: Failed to read interface name from line ${a}: \'${i[a]}\'`);continue}o.includes(d)||o.push(d)}o.length?e(o):t(new Error(r.NOTHING_FOUND_MESSAGE))})})}static getFreeBSDNetworkInterfaces(){return new Promise((e,t)=>{Te.default.exec("arp -a -n",(n,s)=>{if(n){t(n);return}let i=s.split(O.default.EOL),o=[];for(let a=0;a<i.length-1;a++){let c=i[a].trim().split(r.SPACE_PATTERN)[5];if(!c){x(`FreeBSD: Failed to read interface name from line ${a}: \'${i[a]}\'`);continue}o.includes(c)||o.push(c)}o.length?e(o):t(new Error(r.NOTHING_FOUND_MESSAGE))})})}static getOpenBSD_SUNOS_NetworkInterfaces(){return new Promise((e,t)=>{Te.default.exec("arp -a -n",(n,s)=>{if(n){t(n);return}let i=O.default.platform()==="sunos"?0:2,o=s.split(O.default.EOL),a=[];for(let c=1;c<o.length-1;c++){let u=o[c].trim().split(r.SPACE_PATTERN)[i];if(!u){x(`${O.default.platform()}: Failed to read interface name from line ${c}: \'${o[c]}\'`);continue}a.includes(u)||a.push(u)}a.length?e(a):t(new Error(r.NOTHING_FOUND_MESSAGE))})})}static getDarwinWifiNetworkState(e){return new Promise(t=>{Te.default.exec("networksetup -getairportnetwork "+e,(n,s)=>{if(n){if(s.includes("not a Wi-Fi interface")){t(1);return}console.log(`CIAO WARN: While checking networksetup for ${e} encountered an error (${n.message}) with output: ${s.replace(O.default.EOL,"; ")}`),t(0);return}let i=0;s.includes("not a Wi-Fi interface")?i=1:s.includes("Current Wi-Fi Network")?i=3:s.includes("not associated")?i=2:s.includes("All Wi-Fi network services are disabled")?i=1:console.log(`CIAO WARN: While checking networksetup for ${e} encountered an unknown output: ${s.replace(O.default.EOL,"; ")}`),t(i)})})}};Y.NetworkManager=Le;Le.SPACE_PATTERN=/\\s+/g;Le.NOTHING_FOUND_MESSAGE="no interfaces found";Le.POLLING_TIME=15*1e3});var $r=g($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.CiaoService=$.InternalServiceEvent=$.ServiceEvent=$.ServiceState=$.ServiceType=void 0;var qt=(N(),A(C)),D=qt.__importDefault(w("assert")),ic=qt.__importDefault(Z()),oc=w("events"),ac=qt.__importDefault(w("net")),jr=_t(),cc=bt(),Ws=xr(),me=Lt(),uc=Dt(),dc=kt(),lc=B(),hc=Gr(),fc=Br(),oe=ne(),Ve=qt.__importStar(Ne()),xt=Ne(),Ut=(0,ic.default)("ciao:CiaoService"),pc=/^(.*) \\((\\d+)\\)$/,gc=/^(.*)-\\((\\d+)\\)(\\.\\w{2,}.)$/,Hs;(function(r){r.AIRDROP="airdrop",r.AIRPLAY="airplay",r.AIRPORT="airport",r.COMPANION_LINK="companion-link",r.DACP="dacp",r.HAP="hap",r.HOMEKIT="homekit",r.HTTP="http",r.HTTP_ALT="http_alt",r.IPP="ipp",r.IPPS="ipps",r.RAOP="raop",r.scanner="scanner",r.TOUCH_ABLE="touch-able",r.DNS_SD="dns-sd",r.PRINTER="printer"})(Hs||($.ServiceType=Hs={}));var Vs;(function(r){r.UNANNOUNCED="unannounced",r.PROBING="probing",r.PROBED="probed",r.ANNOUNCING="announcing",r.ANNOUNCED="announced"})(Vs||($.ServiceState=Vs={}));var Ks;(function(r){r.NAME_CHANGED="name-change",r.HOSTNAME_CHANGED="hostname-change"})(Ks||($.ServiceEvent=Ks={}));var zs;(function(r){r.PUBLISH="publish",r.UNPUBLISH="unpublish",r.REPUBLISH="republish",r.RECORD_UPDATE="records-update",r.RECORD_UPDATE_ON_INTERFACE="records-update-interface"})(zs||($.InternalServiceEvent=zs={}));var Qr=class r extends oc.EventEmitter{constructor(e,t){if(super(),this.serviceState="unannounced",this.destroyed=!1,(0,D.default)(e,"networkManager is required"),(0,D.default)(t,"parameters options is required"),(0,D.default)(t.name,"service options parameter \'name\' is required"),(0,D.default)(t.type,"service options parameter \'type\' is required"),(0,D.default)(t.type.length<=15,"service options parameter \'type\' must not be longer than 15 characters"),this.networkManager=e,this.name=t.name,this.type=t.type,this.subTypes=t.subtypes,this.protocol=t.protocol||"tcp",this.serviceDomain=t.domain||"local",this.fqdn=this.formatFQDN(),this.loweredFqdn=(0,oe.dnsLowerCase)(this.fqdn),this.typePTR=Ve.stringify({type:this.type,protocol:this.protocol,domain:this.serviceDomain}),this.loweredTypePTR=(0,oe.dnsLowerCase)(this.typePTR),this.subTypes&&(this.subTypePTRs=this.subTypes.map(n=>Ve.stringify({subtype:n,type:this.type,protocol:this.protocol,domain:this.serviceDomain})).map(oe.dnsLowerCase)),this.hostname=Ve.formatHostname(t.hostname||this.name,this.serviceDomain).replace(/ /g,"-"),this.loweredHostname=(0,oe.dnsLowerCase)(this.hostname),this.port=t.port,t.restrictedAddresses){(0,D.default)(t.restrictedAddresses.length,"The service property \'restrictedAddresses\' cannot be an empty array!"),this.restrictedAddresses=new Map;for(let n of t.restrictedAddresses)if(ac.default.isIP(n)){if(n==="0.0.0.0"||n==="::")throw new Error(`[${this.fqdn}] Unspecified ip address (${n}) cannot be used to restrict on to!`);let s=fc.NetworkManager.resolveInterface(n);if(!s)throw new Error(`[${this.fqdn}] Could not restrict service to address ${n} as we could not resolve it to an interface name!`);let i=this.restrictedAddresses.get(s);i?i.length&&!i.includes(n)&&i.push(n):this.restrictedAddresses.set(s,[n])}else this.restrictedAddresses.set(n,[])}this.disableIpv6=t.disabledIpv6,this.txt=t.txt?r.txtBuffersFromRecord(t.txt):[],this.incrementName(!0)}advertise(){return(0,D.default)(!this.destroyed,"Cannot publish destroyed service!"),(0,D.default)(this.port,"Service port must be defined before advertising the service on the network!"),this.listeners("name-change").length===0&&Ut("[%s] WARN: No listeners found for a potential name change on the \'name-change\' event!",this.name),new Promise((e,t)=>{this.emit("publish",n=>n?t(n):e())})}end(){return(0,D.default)(!this.destroyed,"Cannot end destroyed service!"),this.serviceState==="unannounced"?Promise.resolve():new Promise((e,t)=>{this.emit("unpublish",n=>n?t(n):e())})}async destroy(){await this.end(),this.destroyed=!0,this.removeAllListeners()}getFQDN(){return this.fqdn}getTypePTR(){return this.typePTR}getLowerCasedSubtypePTRs(){return this.subTypePTRs}getHostname(){return this.hostname}getPort(){return this.port||-1}getTXT(){return this.txt}getLowerCasedFQDN(){return this.loweredFqdn}getLowerCasedTypePTR(){return this.loweredTypePTR}getLowerCasedHostname(){return this.loweredHostname}updateTxt(e,t=!1){if((0,D.default)(!this.destroyed,"Cannot update destroyed service!"),(0,D.default)(e,"txt cannot be undefined"),this.txt=r.txtBuffersFromRecord(e),Ut("[%s] Updating txt record%s...",this.name,t?" silently":""),this.serviceState==="announcing"){if(this.rebuildServiceRecords(),t)return;this.currentAnnouncer.hasSentLastAnnouncement()&&this.currentAnnouncer.awaitAnnouncement().then(()=>{this.queueTxtUpdate()})}else if(this.serviceState==="announced"){if(this.rebuildServiceRecords(),t)return;this.queueTxtUpdate()}}queueTxtUpdate(){this.txtTimer||(this.txtTimer=setTimeout(()=>{this.txtTimer=void 0,this.serviceState==="announced"&&this.emit("records-update",{answers:[this.txtRecord()],additionals:[this.serviceNSECRecord()]})},50))}updatePort(e){(0,D.default)(this.serviceState==="unannounced","Port number cannot be changed when service is already advertised!"),this.port=e}updateName(e){return this.serviceState==="unannounced"?(this.name=e,this.fqdn=this.formatFQDN(),this.loweredFqdn=(0,oe.dnsLowerCase)(this.fqdn),Promise.resolve()):this.end().then(()=>(this.name=e,this.fqdn=this.formatFQDN(),this.loweredFqdn=(0,oe.dnsLowerCase)(this.fqdn),this.advertise()))}static txtBuffersFromRecord(e){let t=[];return Object.entries(e).forEach(([n,s])=>{let i=n+"="+s;t.push(Buffer.from(i))}),t}handleNetworkInterfaceUpdate(e){if((0,D.default)(!this.destroyed,"Cannot update network of destroyed service!"),this.serviceState!=="announced"){this.serviceState==="announcing"&&(this.rebuildServiceRecords(),this.currentAnnouncer.hasSentLastAnnouncement()&&this.currentAnnouncer.awaitAnnouncement().then(()=>{this.handleNetworkInterfaceUpdate(e)}));return}this.rebuildServiceRecords(),(e.added||e.changes)&&this.emit("republish",t=>{t&&(console.log("FATAL Error occurred trying to re-announce service "+this.fqdn+"! We can\'t recover from this!"),console.log(t.stack),process.exit(1))})}incrementName(e){if(this.serviceState!=="unannounced")throw new Error("Service name can only be incremented when in state UNANNOUNCED!");let t=this.name,n=this.hostname,s,i,o,a,c,u=this.name.match(pc);u?(s=u[1],i=parseInt(u[2]),(0,D.default)(i,`Failed to extract name number from ${this.name}. Resulted in ${i}`)):(s=this.name,i=1);let d=this.hostname.match(gc);if(d)o=d[1],a=d[3],c=parseInt(d[2]),(0,D.default)(c,`Failed to extract hostname number from ${this.hostname}. Resulted in ${c}`);else{let h=this.hostname.substring(0,this.hostname.length-1).lastIndexOf(".");o=this.hostname.slice(0,h),a=this.hostname.slice(h),c=1}e||(i++,c++);let l=Math.max(i,c);this.name=l===1?s:`${s} (${l})`,this.hostname=l===1?`${o}${a}`:`${o}-(${l})${a}`,this.loweredHostname=(0,oe.dnsLowerCase)(this.hostname),this.fqdn=this.formatFQDN(),this.loweredFqdn=(0,oe.dnsLowerCase)(this.fqdn),(this.name!==t||this.hostname!==n)&&Ut("[%s] Service changed name \'%s\' -> \'%s\', \'%s\' -> \'%s\'",this.name,t,this.name,n,this.hostname),e||this.rebuildServiceRecords()}informAboutNameUpdates(){let e=this.emit("name-change",this.name),t=this.emit("hostname-change",Ve.removeTLD(this.hostname));!e&&!t&&console.warn(`CIAO: [${this.name}] Service changed name but nobody was listening on the \'name-change\' event!`)}formatFQDN(){if(this.serviceState!=="unannounced")throw new Error("Name can\'t be changed after service was already announced!");let e=Ve.stringify({name:this.name,type:this.type,protocol:this.protocol,domain:this.serviceDomain});return(0,D.default)(e.length<=255,"A fully qualified domain name cannot be longer than 255 characters"),e}rebuildServiceRecords(){(0,D.default)(this.port,"port must be set before building records"),Ut("[%s] Rebuilding service records...",this.name);let e={},t={},n={},s={},i={},o;for(let[a,c]of this.networkManager.getInterfaceMap()){if(!this.advertisesOnInterface(a,!0))continue;let u=this.restrictedAddresses?this.restrictedAddresses.get(a):void 0;u&&u.length===0&&(u=void 0),c.ipv4&&(!u||u.includes(c.ipv4))&&(e[a]=new cc.ARecord(this.hostname,c.ipv4,!0),i[c.ipv4]=new me.PTRRecord((0,xt.formatReverseAddressPTRName)(c.ipv4),this.hostname)),c.ipv6&&!this.disableIpv6&&(!u||u.includes(c.ipv6))&&(t[a]=new jr.AAAARecord(this.hostname,c.ipv6,!0),i[c.ipv6]=new me.PTRRecord((0,xt.formatReverseAddressPTRName)(c.ipv6),this.hostname)),c.globallyRoutableIpv6&&!this.disableIpv6&&(!u||u.includes(c.globallyRoutableIpv6))&&(n[a]=new jr.AAAARecord(this.hostname,c.globallyRoutableIpv6,!0),i[c.globallyRoutableIpv6]=new me.PTRRecord((0,xt.formatReverseAddressPTRName)(c.globallyRoutableIpv6),this.hostname)),c.uniqueLocalIpv6&&!this.disableIpv6&&(!u||u.includes(c.uniqueLocalIpv6))&&(s[a]=new jr.AAAARecord(this.hostname,c.uniqueLocalIpv6,!0),i[c.uniqueLocalIpv6]=new me.PTRRecord((0,xt.formatReverseAddressPTRName)(c.uniqueLocalIpv6),this.hostname))}if(this.subTypePTRs){o=[];for(let a of this.subTypePTRs)o.push(new me.PTRRecord(a,this.fqdn))}this.serviceRecords={ptr:new me.PTRRecord(this.typePTR,this.fqdn),subtypePTRs:o,metaQueryPtr:new me.PTRRecord(hc.Responder.SERVICE_TYPE_ENUMERATION_NAME,this.typePTR),srv:new uc.SRVRecord(this.fqdn,this.hostname,this.port,!0),txt:new dc.TXTRecord(this.fqdn,this.txt,!0),serviceNSEC:new Ws.NSECRecord(this.fqdn,this.fqdn,[16,33],4500,!0),a:e,aaaa:t,aaaaR:n,aaaaULA:s,reverseAddressPTRs:i,addressNSEC:new Ws.NSECRecord(this.hostname,this.hostname,[1,28],120,!0)}}advertisesOnInterface(e,t){var n,s,i,o;return!this.restrictedAddresses||this.restrictedAddresses.has(e)&&(t||!!(!((n=this.serviceRecords)===null||n===void 0)&&n.a[e])||!!(!((s=this.serviceRecords)===null||s===void 0)&&s.aaaa[e])||!!(!((i=this.serviceRecords)===null||i===void 0)&&i.aaaaR[e])||!!(!((o=this.serviceRecords)===null||o===void 0)&&o.aaaaULA[e]))}ptrRecord(){return this.serviceRecords.ptr.clone()}subtypePtrRecords(){return this.serviceRecords.subtypePTRs?lc.ResourceRecord.clone(this.serviceRecords.subtypePTRs):[]}metaQueryPtrRecord(){return this.serviceRecords.metaQueryPtr.clone()}srvRecord(){return this.serviceRecords.srv.clone()}txtRecord(){return this.serviceRecords.txt.clone()}aRecord(e){let t=this.serviceRecords.a[e];return t?t.clone():void 0}aaaaRecord(e){let t=this.serviceRecords.aaaa[e];return t?t.clone():void 0}aaaaRoutableRecord(e){let t=this.serviceRecords.aaaaR[e];return t?t.clone():void 0}aaaaUniqueLocalRecord(e){let t=this.serviceRecords.aaaaULA[e];return t?t.clone():void 0}allAddressRecords(){let e=[];return Object.values(this.serviceRecords.a).forEach(t=>{e.push(t.clone())}),Object.values(this.serviceRecords.aaaa).forEach(t=>{e.push(t.clone())}),Object.values(this.serviceRecords.aaaaR).forEach(t=>{e.push(t.clone())}),Object.values(this.serviceRecords.aaaaULA).forEach(t=>{e.push(t.clone())}),e}addressNSECRecord(){return this.serviceRecords.addressNSEC.clone()}serviceNSECRecord(e=!1){let t=this.serviceRecords.serviceNSEC.clone();return e&&(t.ttl=120),t}hasAddress(e){return!!this.serviceRecords.reverseAddressPTRs[e]}};$.CiaoService=Qr});var jt=g(Bt=>{"use strict";Object.defineProperty(Bt,"__esModule",{value:!0});Bt.Question=void 0;var mc=ne(),Ke=class r{constructor(e,t,n=!1,s=1){this.unicastResponseFlag=!1,e.endsWith(".")||(e+="."),this.name=e,this.type=t,this.class=s,this.unicastResponseFlag=n}getLowerCasedName(){return this.lowerCasedName||(this.lowerCasedName=(0,mc.dnsLowerCase)(this.name))}getEncodingLength(e){return e.getNameLength(this.name)+4}encode(e,t,n){let s=n,i=e.encodeName(this.name,n);n+=i,t.writeUInt16BE(this.type,n),n+=2;let o=this.class;return this.unicastResponseFlag&&(o|=r.QU_MASK),t.writeUInt16BE(o,n),n+=2,n-s}clone(){return new r(this.name,this.type,this.unicastResponseFlag,this.class)}asString(){return`Q ${this.name} ${this.type} ${this.class}`}static decode(e,t,n,s){let i=s,o=t.decodeName(s);s+=o.readBytes;let a=n.readUInt16BE(s);s+=2;let c=n.readUInt16BE(s);s+=2;let u=c&this.NOT_QU_MASK,d=!!(c&this.QU_MASK);return{data:new r(o.data,a,d,u),readBytes:s-i}}};Bt.Question=Ke;Ke.QU_MASK=32768;Ke.NOT_QU_MASK=32767});var ze=g(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});L.DNSPacket=L.PacketType=L.QClass=L.RClass=L.QType=L.RType=L.RCode=L.OpCode=void 0;var oi=(N(),A(C)),Oe=oi.__importDefault(w("assert")),vc=oi.__importDefault(He()),Ys=Lr(),ae=Pr(),Xs=jt();Ur();var De=B(),Zs;(function(r){r[r.QUERY=0]="QUERY"})(Zs||(L.OpCode=Zs={}));var Js;(function(r){r[r.NoError=0]="NoError"})(Js||(L.RCode=Js={}));var ei;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.PTR=12]="PTR",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA",r[r.SRV=33]="SRV",r[r.OPT=41]="OPT",r[r.NSEC=47]="NSEC"})(ei||(L.RType=ei={}));var ti;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.PTR=12]="PTR",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA",r[r.SRV=33]="SRV",r[r.NSEC=47]="NSEC",r[r.ANY=255]="ANY"})(ti||(L.QType=ti={}));var ri;(function(r){r[r.IN=1]="IN"})(ri||(L.RClass=ri={}));var ni;(function(r){r[r.IN=1]="IN",r[r.ANY=255]="ANY"})(ni||(L.QClass=ni={}));var si;(function(r){r[r.QUERY=0]="QUERY",r[r.RESPONSE=1]="RESPONSE"})(si||(L.PacketType=si={}));function ii(r){return"answers"in r}function wc(r){return"authorities"in r}var U=class r{constructor(e){this.questions=new Map,this.answers=new Map,this.authorities=new Map,this.additionals=new Map,this.estimatedEncodingLength=0,this.lastCalculatedLength=0,this.lengthDirty=!0,this.id=e.id||0,this.legacyUnicastEncoding=e.legacyUnicast||!1,this.type=e.type,this.opcode=e.opcode||0,this.flags=e.flags||{},this.rcode=e.rCode||0,this.type===1&&(this.flags.authoritativeAnswer=!0),e.questions&&this.addQuestions(...e.questions),e.answers&&this.addAnswers(...e.answers),e.authorities&&this.addAuthorities(...e.authorities),e.additionals&&this.addAdditionals(...e.additionals)}static createDNSQueryPacket(e,t=this.UDP_PAYLOAD_SIZE_IPV4){let n=this.createDNSQueryPackets(e,t);return(0,Oe.default)(n.length===1,"Cannot user short method createDNSQueryPacket when query packets are more than one: is "+n.length),n[0]}static createDNSQueryPackets(e,t=this.UDP_PAYLOAD_SIZE_IPV4){let n=[],s=new r({type:0,questions:e.questions,additionals:ii(e)?e.additionals:void 0});if(n.push(s),s.getEstimatedEncodingLength()>t){let i=s.getEncodingLength();i>t&&Oe.default.fail("Cannot send query where already the query section is exceeding the udpPayloadSize ("+i+">"+t+")!")}if(ii(e)&&e.answers){let i=s,o=0,a=e.answers.concat([]);for(a.sort((c,u)=>c.getEncodingLength(ae.NonCompressionLabelCoder.INSTANCE)-u.getEncodingLength(ae.NonCompressionLabelCoder.INSTANCE));o<a.length;){for(;o<a.length;o++){let c=a[o],u=c.getEncodingLength(ae.NonCompressionLabelCoder.INSTANCE);if(s.getEstimatedEncodingLength()+u<=t)i.addAnswers(c);else if(s.getEncodingLength()+u<=t)i.addAnswers(c);else{i.questions.size===0&&i.answers.size===0&&s.addAnswers(c);break}}o<a.length&&(i.flags.truncation=!0,i=new r({type:0}),n.push(i))}}else if(wc(e)&&e.authorities){s.addAuthorities(...e.authorities);let i=s.getEncodingLength();i>t&&Oe.default.fail(`Probe query packet exceeds the mtu size (${i}>${t}). Can\'t split probe queries at the moment!`)}return n}static createDNSResponsePacketsFromRRSet(e,t=this.UDP_PAYLOAD_SIZE_IPV4){let n=new r({id:e.id,legacyUnicast:e.legacyUnicast,type:1,flags:{authoritativeAnswer:!0},questions:e.questions,answers:e.answers,additionals:e.additionals});return n.getEncodingLength()>t&&Oe.default.fail("Couldn\'t construct a dns response packet from a rr set which fits in an udp payload sized packet!"),n}canBeCombinedWith(e,t=r.UDP_PAYLOAD_SIZE_IPV4){return this.id===e.id&&this.type===e.type&&this.opcode===e.opcode&&(0,vc.default)(this.flags,e.flags)&&this.rcode===e.rcode&&this.getEncodingLength()+e.getEncodingLength()<=t}combineWith(e){this.setLegacyUnicastEncoding(this.legacyUnicastEncoding||e.legacyUnicastEncoding),this.addRecords(this.questions,e.questions.values()),this.addRecords(this.answers,e.answers.values(),this.additionals),this.addRecords(this.authorities,e.authorities.values()),this.addRecords(this.additionals,e.additionals.values())}addQuestions(...e){return this.addRecords(this.questions,e)}addAnswers(...e){return this.addRecords(this.answers,e,this.additionals)}addAuthorities(...e){return this.addRecords(this.authorities,e)}addAdditionals(...e){return this.addRecords(this.additionals,e)}addRecords(e,t,n){let s=!1;for(let i of t)e.has(i.asString())||(this.estimatedEncodingLength&&(this.estimatedEncodingLength+=i.getEncodingLength(ae.NonCompressionLabelCoder.INSTANCE)),e.set(i.asString(),i),s=!0,this.lengthDirty=!0,n&&n.delete(i.asString()));return s}setLegacyUnicastEncoding(e){this.legacyUnicastEncoding!==e&&(this.lengthDirty=!0),this.legacyUnicastEncoding=e}legacyUnicastEncodingEnabled(){return this.legacyUnicastEncoding}getEstimatedEncodingLength(){if(this.estimatedEncodingLength)return this.estimatedEncodingLength;let e=ae.NonCompressionLabelCoder.INSTANCE,t=r.DNS_PACKET_HEADER_SIZE;for(let n of this.questions.values())t+=n.getEncodingLength(e);for(let n of this.answers.values())t+=n.getEncodingLength(e);for(let n of this.authorities.values())t+=n.getEncodingLength(e);for(let n of this.additionals.values())t+=n.getEncodingLength(e);return this.estimatedEncodingLength=t,t}getEncodingLength(e){if(!this.lengthDirty)return this.lastCalculatedLength;let t=e||new ae.DNSLabelCoder(this.legacyUnicastEncoding),n=r.DNS_PACKET_HEADER_SIZE;for(let s of this.questions.values())n+=s.getEncodingLength(t);for(let s of this.answers.values())n+=s.getEncodingLength(t);for(let s of this.authorities.values())n+=s.getEncodingLength(t);for(let s of this.additionals.values())n+=s.getEncodingLength(t);return this.lengthDirty=!1,this.lastCalculatedLength=n,this.estimatedEncodingLength=n,n}encode(){let e=new ae.DNSLabelCoder(this.legacyUnicastEncoding),t=this.getEncodingLength(e),n=Buffer.allocUnsafe(t);e.initBuf(n);let s=0;n.writeUInt16BE(this.id,s),s+=2;let i=this.type<<15|this.opcode<<11|this.rcode;this.flags.authoritativeAnswer&&(i|=r.AUTHORITATIVE_ANSWER_MASK),this.flags.truncation&&(i|=r.TRUNCATION_MASK),this.flags.recursionDesired&&(i|=r.RECURSION_DESIRED_MASK),this.flags.recursionAvailable&&(i|=r.RECURSION_AVAILABLE_MASK),this.flags.zero&&(i|=r.ZERO_HEADER_MASK),this.flags.authenticData&&(i|=r.AUTHENTIC_DATA_MASK),this.flags.checkingDisabled&&(i|=r.CHECKING_DISABLED_MASK),n.writeUInt16BE(i,s),s+=2,n.writeUInt16BE(this.questions.size,s),s+=2,n.writeUInt16BE(this.answers.size,s),s+=2,n.writeUInt16BE(this.authorities.size,s),s+=2,n.writeUInt16BE(this.additionals.size,s),s+=2;for(let o of this.questions.values()){let a=o.encode(e,n,s);s+=a}for(let o of this.answers.values()){let a=o.encode(e,n,s);s+=a}for(let o of this.authorities.values()){let a=o.encode(e,n,s);s+=a}for(let o of this.additionals.values()){let a=o.encode(e,n,s);s+=a}return(0,Oe.default)(s===n.length,"Bytes written didn\'t match the buffer size!"),n}static decode(e,t,n=0){let s=new ae.DNSLabelCoder;s.initBuf(t);let i=t.readUInt16BE(n);n+=2;let o=t.readUInt16BE(n);n+=2;let a=t.readUInt16BE(n);n+=2;let c=t.readUInt16BE(n);n+=2;let u=t.readUInt16BE(n);n+=2;let d=t.readUInt16BE(n);n+=2;let l=[],h=[],f=[],v=[];n+=r.decodeList(e,s,t,n,a,Xs.Question.decode.bind(Xs.Question),l),n+=r.decodeList(e,s,t,n,c,De.ResourceRecord.decode.bind(De.ResourceRecord),h),n+=r.decodeList(e,s,t,n,u,De.ResourceRecord.decode.bind(De.ResourceRecord),f),n+=r.decodeList(e,s,t,n,d,De.ResourceRecord.decode.bind(De.ResourceRecord),v),(0,Oe.default)(n===t.length,"Didn\'t read the full buffer (offset="+n+", length="+t.length+")");let m=o>>15,R=o>>11&15,y=o&15,E={};return o&this.AUTHORITATIVE_ANSWER_MASK&&(E.authoritativeAnswer=!0),o&this.TRUNCATION_MASK&&(E.truncation=!0),o&this.RECURSION_DESIRED_MASK&&(E.recursionDesired=!0),o&this.RECURSION_AVAILABLE_MASK&&(E.recursionAvailable=!0),o&this.ZERO_HEADER_MASK&&(E.zero=!0),o&this.AUTHENTIC_DATA_MASK&&(E.authenticData=!0),o&this.CHECKING_DISABLED_MASK&&(E.checkingDisabled=!0),new r({id:i,type:m,opcode:R,rCode:y,flags:E,questions:l,answers:h,authorities:f,additionals:v})}static decodeList(e,t,n,s,i,o,a){let c=s;for(let u=0;u<i;u++){let d=o(e,t,n,s);s+=d.readBytes,d.data&&a.push(d.data)}return s-c}asLoggingString(e){let t="",n="";for(let o of this.answers.values())t&&(t+=","),t+=(0,Ys.dnsTypeToString)(o.type);for(let o of this.additionals.values())n&&(n+=","),n+=(0,Ys.dnsTypeToString)(o.type);let s=[];this.legacyUnicastEncodingEnabled()&&s.push("U"),e&&s.push("UPS: "+e);let i=s.length!==0?` (${s})`:"";return`[${t}] answers and [${n}] additionals with size ${this.getEncodingLength()}B${i}`}};L.DNSPacket=U;U.UDP_PAYLOAD_SIZE_IPV4=process.env.CIAO_UPS?parseInt(process.env.CIAO_UPS):1440;U.UDP_PAYLOAD_SIZE_IPV6=process.env.CIAO_UPS?parseInt(process.env.CIAO_UPS):1440;U.AUTHORITATIVE_ANSWER_MASK=1024;U.TRUNCATION_MASK=512;U.RECURSION_DESIRED_MASK=256;U.RECURSION_AVAILABLE_MASK=128;U.ZERO_HEADER_MASK=64;U.AUTHENTIC_DATA_MASK=32;U.CHECKING_DISABLED_MASK=16;U.DNS_PACKET_HEADER_SIZE=12});var Vr=g(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.ServerClosedError=H.InterfaceNotFoundError=H.ERR_SERVER_CLOSED=H.ERR_INTERFACE_NOT_FOUND=void 0;H.ERR_INTERFACE_NOT_FOUND="ERR_INTERFACE_NOT_FOUND";H.ERR_SERVER_CLOSED="ERR_SERVER_CLOSED";var Wr=class extends Error{constructor(e){super(e),this.name="ERR_INTERFACE_NOT_FOUND"}};H.InterfaceNotFoundError=Wr;var Hr=class extends Error{constructor(e){super(e),this.name=H.ERR_SERVER_CLOSED}};H.ServerClosedError=Hr});var Qt=g(Kr=>{"use strict";Object.defineProperty(Kr,"__esModule",{value:!0});Kr.PromiseTimeout=yc;function yc(r){return new Promise(e=>{setTimeout(()=>e(),r)})}});var $t=g(Me=>{"use strict";Object.defineProperty(Me,"__esModule",{value:!0});Me.MDNSServer=void 0;Me.SendResultFailedRatio=Ac;Me.SendResultFormatError=Cc;var Yr=(N(),A(C)),Ye=Yr.__importDefault(w("assert")),Rc=Yr.__importDefault(Z()),_c=Yr.__importDefault(w("dgram")),zr=ze(),Sc=Br(),bc=Ne(),ai=Vr(),Ec=Qt(),V=(0,Rc.default)("ciao:MDNSServer");function Ac(r){if(r.length===0)return 0;let e=0;for(let t of r)t.status!=="fulfilled"&&e++;return e/r.length}function Cc(r,e,t=!1){let n=0;for(let s of r)s.status!=="fulfilled"&&n++;if(e||(e="Failed to send packets"),n<r.length?e+=` (${n}/${r.length}):`:e+=":",t){let s=`=============================\n`+e;for(let i of r)i.status==="rejected"?s+=`\n--------------------\nFailed to send packet on interface `+i.interface+": "+i.reason.stack:i.status==="timeout"&&(s+=`\n--------------------\nSending packet on interface `+i.interface+" timed out!");return s+=`\n=============================`,s}else{let s=e;for(let i of r)i.status==="rejected"?s+=`\n- Failed to send packet on interface `+i.interface+": "+i.reason.message:i.status==="timeout"&&(s+=`\n- Sending packet on interface `+i.interface+" timed out!");return s}}var K=class r{constructor(e,t){this.sockets=new Map,this.sentPackets=new Map,this.suppressUnicastResponseFlag=!1,this.bound=!1,this.closed=!1,this.advertiseFamilies=[],(0,Ye.default)(e,"handler cannot be undefined"),this.handler=e,this.networkManager=new Sc.NetworkManager({interface:t&&t.interface,excludeIpv6:t&&t.disableIpv6,excludeIpv6Only:t&&t.excludeIpv6Only}),t&&t.advertiseIpv4===!1||this.advertiseFamilies.push("IPv4"),t&&t.advertiseIpv6&&this.advertiseFamilies.push("IPv6"),this.networkManager.on("network-update",this.handleUpdatedNetworkInterfaces.bind(this))}getNetworkManager(){return this.networkManager}getBoundInterfaceNames(){return this.sockets.keys()}async bind(){if(this.closed)throw new Error("Cannot rebind closed server!");this.suppressUnicastResponseFlag=!0,await this.networkManager.waitForInit();let e=[];for(let[t,n]of this.networkManager.getInterfaceMap())this.advertiseFamilies.forEach(s=>{let i=this.createDgramSocket(t,!0,s==="IPv6"?"udp6":"udp4"),o=this.bindSocket(i,n,s).catch(a=>{console.log("Could not bind detected network interface: "+a.stack)});e.push(o)});return Promise.all(e).then(()=>{this.bound=!0})}shutdown(){this.networkManager.shutdown();for(let e of this.sockets.values())e.close();this.bound=!1,this.closed=!0,this.sockets.clear()}sendQueryBroadcast(e,t){let n=zr.DNSPacket.createDNSQueryPackets(e);n.length>1&&V("Query broadcast is split into %d packets!",n.length);let s=[];for(let i of n)s.push(this.sendOnAllNetworksForService(i,t));return Promise.all(s).then(i=>{let o=[];for(let a of i)o.concat(a);return o})}sendResponseBroadcast(e,t){let n=zr.DNSPacket.createDNSResponsePacketsFromRRSet(e);return this.sendOnAllNetworksForService(n,t)}sendResponse(e,t,n){this.send(e,t).then(s=>{s.status==="rejected"?n?n(new Error("Encountered socket error on "+s.reason.name+": "+s.reason.message)):r.logSocketError(s.interface,s.reason):n&&n()})}sendOnAllNetworksForService(e,t){this.checkUnicastResponseFlag(e);let n=e.encode();this.assertBeforeSend(n,"IPv4");let s=[];for(let[i,o]of this.sockets){if(!t.advertisesOnInterface(i))continue;let a=i.endsWith("/6"),c=new Promise(u=>{o.send(n,r.MDNS_PORT,a?r.MULTICAST_IPV6:r.MULTICAST_IPV4,d=>{if(d){if(!r.isSilencedSocketError(d)){u({status:"rejected",interface:i,reason:d});return}}else this.maintainSentPacketsInterface(i,n);u({status:"fulfilled",interface:i})})});s.push(Promise.race([c,(0,Ec.PromiseTimeout)(r.SEND_TIMEOUT).then(()=>({status:"timeout",interface:i}))]))}return Promise.all(s)}send(e,t){this.checkUnicastResponseFlag(e);let n=e.encode(),s,i,o,a;typeof t=="string"?(a=t.endsWith("/6"),s=a?r.MULTICAST_IPV6:r.MULTICAST_IPV4,i=r.MDNS_PORT,o=t):(a=t.interface.endsWith("/6"),s=t.address,i=t.port,o=t.interface),this.assertBeforeSend(n,a?"IPv6":"IPv4");let c=this.sockets.get(o);if(!c)throw new ai.InterfaceNotFoundError(`Could not find socket for given network interface \'${o}\'`);return new Promise(u=>{c.send(n,i,s,d=>{if(d){if(!r.isSilencedSocketError(d)){u({status:"rejected",interface:o,reason:d});return}}else this.maintainSentPacketsInterface(o,n);u({status:"fulfilled",interface:o})})})}checkUnicastResponseFlag(e){this.suppressUnicastResponseFlag&&e.type===0&&e.questions.forEach(t=>t.unicastResponseFlag=!1)}assertBeforeSend(e,t){if(this.closed)throw new ai.ServerClosedError("Cannot send packets on a closed mdns server!");(0,Ye.default)(this.bound,"Cannot send packets before server is not bound!");let n=t==="IPv4"?r.DEFAULT_IP4_HEADER:r.DEFAULT_IP6_HEADER;(0,Ye.default)(n+r.UDP_HEADER+e.length<=9e3,"DNS cannot exceed the size of 9000 bytes even with IP Fragmentation!")}maintainSentPacketsInterface(e,t){let n=t.toString("base64"),s=this.sentPackets.get(e);s?s.push(n):this.sentPackets.set(e,[n])}checkIfPacketWasPreviouslySentFromUs(e,t){let n=t.toString("base64"),s=this.sentPackets.get(e);if(s){let i=s.indexOf(n);if(i!==-1)return s.splice(i,1),!0}return!1}createDgramSocket(e,t=!1,n="udp4"){let s=_c.default.createSocket({type:n,reuseAddr:t});return s.on("message",(i,o)=>this.handleMessage(e,i,o,n==="udp6"?"IPv6":"IPv4")),s.on("error",i=>{r.isSilencedSocketError(i)||r.logSocketError(e,i)}),s}bindSocket(e,t,n){return new Promise((s,i)=>{let o=c=>i(new Error("Failed to bind on interface "+t.name+": "+c.message)),a=n==="IPv6";e.once("error",o),e.on("close",()=>{this.sockets.delete(t.name+(a?"/6":""))}),e.bind(r.MDNS_PORT,()=>{e.setRecvBufferSize(800*1024),e.removeListener("error",o);let c=a?r.MULTICAST_IPV6:r.MULTICAST_IPV4,u=a?t.ipv6:t.ipv4;if(!u){console.log("Warning: no "+(a?"IPv6":"IPv4")+" address available on "+t.name);try{e.close()}catch{}s();return}try{e.addMembership(c,u),e.setMulticastInterface(a?u+"%"+t.name:u),e.setMulticastTTL(r.MDNS_TTL),e.setTTL(r.MDNS_TTL),e.setMulticastLoopback(!0),this.sockets.set(a?t.name+"/6":t.name,e),s()}catch(d){try{e.close()}catch(l){V("Error while closing socket which failed to bind. Error may be expected: "+l.message)}i(new Error("Error binding socket on "+t.name+": "+d.stack))}})})}handleMessage(e,t,n,s){if(!this.bound)return;let i=this.networkManager.getInterface(e);if(!i){V("Received packet on non existing network interface: %s!",e);return}if(this.checkIfPacketWasPreviouslySentFromUs(i.name,t))return;let o=s==="IPv6";if(o)i.loopback!==n.address.includes("%lo")&&V("Received packet on a %s interface (%s) which is coming from a %s interface (%s)",i.loopback?"loopback":"non-loopback",e,n.address.includes("%lo")?"loopback":"non-loopback",n.address);else{let u=(0,bc.getNetAddress)(n.address,i.ip4Netmask);if(i.loopback){if(u!==i.ipv4Netaddress)return}else if(this.networkManager.isLoopbackNetaddressV4(u)){V("Received packet on interface \'%s\' which is not coming from the same subnet: %o",e,{address:n.address,netaddress:u,interface:i.ipv4});return}}let a;try{a=zr.DNSPacket.decode(n,t)}catch(u){V("Received a malformed packet from %o on interface %s. This might or might not be a problem. Here is the received packet for debugging purposes \'%s\'. Packet decoding failed with %s",n,e,t.toString("base64"),u.stack);return}if(a.opcode!==0||a.rcode!==0)return;let c={address:n.address,port:n.port,interface:e+(o?"/6":"")};if(a.type===0)try{this.handler.handleQuery(a,c)}catch(u){console.warn("Error occurred handling incoming (on "+e+") dns query packet: "+u.stack)}else if(a.type===1){if(n.port!==r.MDNS_PORT)return;try{this.handler.handleResponse(a,c)}catch(u){console.warn("Error occurred handling incoming (on "+e+") dns response packet: "+u.stack)}}}static isSilencedSocketError(e){let t=e.message.includes("EADDRNOTAVAIL")||e.message.includes("EHOSTDOWN")||e.message.includes("ENETUNREACH")||e.message.includes("EHOSTUNREACH")||e.message.includes("EPERM")||e.message.includes("EINVAL");return t&&V("Silenced and ignored error (This is/should not be a problem, this message is only for informational purposes): "+e.message),t}static logSocketError(e,t){console.warn(`Encountered MDNS socket error on socket \'${e}\' : ${t.stack}`)}handleUpdatedNetworkInterfaces(e){if(e.removed)for(let t of e.removed){let n=this.sockets.get(t.name);this.sockets.delete(t.name),n&&n.close(),n=this.sockets.get(t.name+"/6"),this.sockets.delete(t.name+"/6"),n&&n.close()}if(e.changes)for(let t of e.changes){let n=this.sockets.get(t.name);if(!t.outdatedIpv4&&t.updatedIpv4)Ye.default.fail("Reached illegal state! IPv4 address changed from undefined to defined!");else if(t.outdatedIpv4&&!t.updatedIpv4)Ye.default.fail("Reached illegal state! IPV4 address change from defined to undefined!");else if(n&&t.outdatedIpv4&&t.updatedIpv4){try{n.dropMembership(r.MULTICAST_IPV4,t.outdatedIpv4)}catch(s){V("Thrown unexpected error when dropping outdated address membership: "+s.message)}try{n.addMembership(r.MULTICAST_IPV4,t.updatedIpv4)}catch(s){V("Thrown unexpected error when adding new address membership: "+s.message)}n.setMulticastInterface(t.updatedIpv4)}if(n=this.sockets.get(t.name+"/6"),n&&t.outdatedIpv6&&t.updatedIpv6){try{n.dropMembership(r.MULTICAST_IPV6,t.outdatedIpv6)}catch(s){V("Thrown unexpected error when dropping outdated address membership: "+s.message)}try{n.addMembership(r.MULTICAST_IPV6,t.updatedIpv6)}catch(s){V("Thrown unexpected error when adding new address membership: "+s.message)}}}if(e.added)for(let t of e.added)this.advertiseFamilies.forEach(n=>{let s=this.createDgramSocket(t.name,!0,n==="IPv6"?"udp6":"udp4");this.bindSocket(s,t,n).catch(i=>{console.log("Could not bind detected network interface: "+i.stack)})})}};Me.MDNSServer=K;K.DEFAULT_IP4_HEADER=20;K.DEFAULT_IP6_HEADER=40;K.UDP_HEADER=8;K.MDNS_PORT=5353;K.MDNS_TTL=255;K.MULTICAST_IPV4="224.0.0.251";K.MULTICAST_IPV6="FF02::FB";K.SEND_TIMEOUT=200});var ui=g(Ht=>{"use strict";Object.defineProperty(Ht,"__esModule",{value:!0});Ht.Announcer=void 0;var ci=(N(),A(C)),Xr=ci.__importDefault(w("assert")),Nc=ci.__importDefault(Z()),Ic=ze(),Gt=$t(),Tc=Qt(),Xe=(0,Nc.default)("ciao:Announcer"),Wt=class r{constructor(e,t,n){this.repetitions=1,this.announceIntervalIncreaseFactor=2,this.goodbye=!1,this.sentAnnouncements=0,this.sentLastAnnouncement=!1,this.nextInterval=1e3,this.nextAnnouncementTime=0,(0,Xr.default)(e,"server must be defined"),(0,Xr.default)(t,"service must be defined"),this.server=e,this.service=t,n&&(n.repetitions!==void 0&&(this.repetitions=n.repetitions),n.goodbye&&(this.goodbye=!0)),(0,Xr.default)(this.repetitions>0&&this.repetitions<=8,"repetitions must in [1;8]")}announce(){return Xe("[%s] Sending %s for service",this.service.getFQDN(),this.goodbye?"goodbye":"announcement"),this.goodbye||this.service.rebuildServiceRecords(),this.promise=new Promise((e,t)=>{this.promiseResolve=e,this.promiseReject=t,this.timer=setTimeout(this.sendAnnouncement.bind(this),0),this.timer.unref(),this.nextAnnouncementTime=new Date().getTime()})}async cancel(){return Xe("[%s] Canceling %s",this.service.getFQDN(),this.goodbye?"goodbye":"announcement"),this.timer&&(clearTimeout(this.timer),this.timer=void 0),this.promiseReject(r.CANCEL_REASON),this.awaitAnnouncement().catch(e=>{if(e!==r.CANCEL_REASON)return Promise.reject(e)})}hasSentLastAnnouncement(){return this.sentLastAnnouncement}async awaitAnnouncement(){await this.promise}isSendingGoodbye(){return this.goodbye}sendAnnouncement(){Xe("[%s] Sending %s number %d",this.service.getFQDN(),this.goodbye?"goodbye":"announcement",this.sentAnnouncements+1);let e=[this.service.ptrRecord(),...this.service.subtypePtrRecords(),this.service.srvRecord(),this.service.txtRecord()];if(this.goodbye)for(let t of e)t.ttl=0;else e.push(this.service.metaQueryPtrRecord());this.sentAnnouncements+1>=this.repetitions&&(this.sentLastAnnouncement=!0),r.sendResponseAddingAddressRecords(this.server,this.service,e,this.goodbye).then(t=>{let n=(0,Gt.SendResultFailedRatio)(t);if(n===1){console.error((0,Gt.SendResultFormatError)(t,`[${this.service.getFQDN()}] Failed to send ${this.goodbye?"goodbye":"announcement"} requests`),!0),this.promiseReject(new Error(`${this.goodbye?"Goodbye":"Announcement"} failed as of socket errors!`));return}if(n>0&&Xe((0,Gt.SendResultFormatError)(t,`Some of the ${this.goodbye?"goodbye":"announcement"} requests for \'${this.service.getFQDN()}\' encountered an error`)),this.service.serviceState!=="announcing"){Xe("[%s] Service is no longer in announcing state. Stopping. (Received %s)",this.service.getFQDN(),this.service.serviceState);return}this.sentAnnouncements++,this.sentAnnouncements>=this.repetitions?this.promiseResolve():(this.timer=setTimeout(this.sendAnnouncement.bind(this),this.nextInterval),this.timer.unref(),this.nextAnnouncementTime=new Date().getTime()+this.nextInterval,this.nextInterval*=this.announceIntervalIncreaseFactor)})}static sendResponseAddingAddressRecords(e,t,n,s){let i=[];for(let o of e.getBoundInterfaceNames()){if(!t.advertisesOnInterface(o))continue;let a=n.concat([]),c=t.aRecord(o),u=t.aaaaRecord(o),d=t.aaaaRoutableRecord(o),l=t.aaaaUniqueLocalRecord(o),h=t.addressNSECRecord(),f=t.serviceNSECRecord();c&&(s&&(c.ttl=0),a.push(c)),u&&(s&&(u.ttl=0),a.push(u)),d&&(s&&(d.ttl=0),a.push(d)),l&&(s&&(l.ttl=0),a.push(l)),s&&(h.ttl=0,f.ttl=0);let v=[];v.push(h,f);let m=Ic.DNSPacket.createDNSResponsePacketsFromRRSet({answers:a,additionals:v});i.push(Promise.race([e.send(m,o),(0,Tc.PromiseTimeout)(Gt.MDNSServer.SEND_TIMEOUT).then(()=>({status:"timeout",interface:o}))]))}return Promise.all(i)}};Ht.Announcer=Wt;Wt.CANCEL_REASON="CIAO ANNOUNCEMENT CANCELLED"});var Zr=g(Fe=>{"use strict";Object.defineProperty(Fe,"__esModule",{value:!0});Fe.TiebreakingResult=void 0;Fe.rrComparator=li;Fe.runTiebreaking=Lc;function li(r,e){if(r.class!==e.class)return r.class-e.class;if(r.type!==e.type)return r.type-e.type;let t=r.getRawData(),n=e.getRawData(),s=Math.max(t.length,n.length);for(let i=0;i<s;i++){if(i>=t.length&&i<n.length)return-1;if(i>=n.length&&i<t.length)return 1;let o=t.readUInt8(i),a=n.readUInt8(i);if(o!==a)return o<a?-1:1}return 0}var di;(function(r){r[r.OPPONENT=-1]="OPPONENT",r[r.TIE=0]="TIE",r[r.HOST=1]="HOST"})(di||(Fe.TiebreakingResult=di={}));function Lc(r,e){let t=Math.max(r.length,e.length);for(let n=0;n<t;n++){if(n>=r.length&&n<e.length)return-1;if(n>=e.length&&n<r.length)return 1;let s=li(r[n],e[n]);if(s!==0)return s}return 0}});var gi=g(zt=>{"use strict";Object.defineProperty(zt,"__esModule",{value:!0});zt.Prober=void 0;var en=(N(),A(C)),Vt=en.__importDefault(w("assert")),Pc=en.__importDefault(Z()),hi=jt(),Jr=$t(),fi=en.__importStar(Zr()),Oc=Zr(),pi=250,Dc=1e3,ee=(0,Pc.default)("ciao:Prober"),Kt=class r{constructor(e,t,n){this.records=[],this.currentInterval=pi,this.serviceEncounteredNameChange=!1,this.sentFirstProbeQuery=!1,this.sentQueriesForCurrentTry=0,this.sentQueries=0,(0,Vt.default)(e,"responder must be defined"),(0,Vt.default)(t,"server must be defined"),(0,Vt.default)(n,"service must be defined"),this.responder=e,this.server=t,this.service=n}getService(){return this.service}probe(){return ee("Starting to probe for \'%s\'...",this.service.getFQDN()),new Promise((e,t)=>{this.promiseResolve=e,this.promiseReject=t,this.timer=setTimeout(this.sendProbeRequest.bind(this),Math.random()*pi),this.timer.unref()})}cancel(){this.clear(),this.promiseReject(r.CANCEL_REASON)}clear(){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this.sentFirstProbeQuery=!1,this.sentQueriesForCurrentTry=0}endProbing(e){this.clear(),e&&(ee("Probing for \'%s\' finished successfully",this.service.getFQDN()),this.promiseResolve(),this.serviceEncounteredNameChange&&this.service.informAboutNameUpdates())}sendProbeRequest(){if(this.sentQueriesForCurrentTry===0&&(this.records=[this.service.srvRecord(),this.service.txtRecord(),this.service.ptrRecord(),...this.service.subtypePtrRecords(),...this.service.allAddressRecords()].sort(Oc.rrComparator),this.records.forEach(t=>t.flushFlag=!1)),this.sentQueriesForCurrentTry>=3){this.endProbing(!0);return}this.sentQueries>=15&&(this.currentInterval=Dc),ee("Sending prober query number %d for \'%s\'...",this.sentQueriesForCurrentTry+1,this.service.getFQDN()),(0,Vt.default)(this.records.length>0,"Tried sending probing request for zero record length!");let e=[new hi.Question(this.service.getFQDN(),255,!0),new hi.Question(this.service.getHostname(),255,!0)];this.server.sendQueryBroadcast({questions:e,authorities:this.records},this.service).then(t=>{let n=(0,Jr.SendResultFailedRatio)(t);if(n===1){console.error((0,Jr.SendResultFormatError)(t,`Failed to send probe queries for \'${this.service.getFQDN()}\'`),!0),this.endProbing(!1),this.promiseReject(new Error("Probing failed as of socket errors!"));return}if(n>0&&ee((0,Jr.SendResultFormatError)(t,`Some of the probe queries for \'${this.service.getFQDN()}\' encountered an error`)),this.service.serviceState!=="probing"){ee("Service \'%s\' is no longer in probing state. Stopping.",this.service.getFQDN());return}this.sentFirstProbeQuery=!0,this.sentQueriesForCurrentTry++,this.sentQueries++,this.timer=setTimeout(this.sendProbeRequest.bind(this),this.currentInterval),this.timer.unref(),this.checkLocalConflicts()})}checkLocalConflicts(){let e=!1;for(let t of this.responder.getAnnouncedServices())if(t.getLowerCasedFQDN()===this.service.getLowerCasedFQDN()||t.getLowerCasedHostname()===this.service.getLowerCasedHostname()){e=!0;break}e&&(ee("Probing for \'%s\' failed as of local service. Doing a name change",this.service.getFQDN()),this.handleNameChange())}handleResponse(e,t){if(!this.sentFirstProbeQuery||!this.service.advertisesOnInterface(t.interface))return;let n=!1;for(let s of e.answers.values())if(s.getLowerCasedName()===this.service.getLowerCasedFQDN()||s.getLowerCasedName()===this.service.getLowerCasedHostname()){n=!0;break}for(let s of e.additionals.values())if(s.getLowerCasedName()===this.service.getLowerCasedFQDN()||s.getLowerCasedName()===this.service.getLowerCasedHostname()){n=!0;break}n&&(ee("Probing for \'%s\' failed. Doing a name change",this.service.getFQDN()),this.handleNameChange())}handleNameChange(){this.endProbing(!1),this.service.serviceState="unannounced",this.service.incrementName(),this.service.serviceState="probing",this.serviceEncounteredNameChange=!0,this.timer=setTimeout(this.sendProbeRequest.bind(this),1e3),this.timer.unref()}handleQuery(e,t){if(!this.sentFirstProbeQuery||!this.service.advertisesOnInterface(t.interface))return;let n=!1;for(let s of e.questions.values())if(s.getLowerCasedName()===this.service.getLowerCasedFQDN()||s.getLowerCasedName()===this.service.getLowerCasedHostname()){n=!0;break}n&&this.doTiebreaking(e)}doTiebreaking(e){if(!this.sentFirstProbeQuery)return;let t=e.authorities.size===0;for(let o of e.authorities.values())if(o.getLowerCasedName()===this.service.getLowerCasedFQDN()||o.getLowerCasedName()===this.service.getLowerCasedHostname()){t=!0;break}if(!t)return;let n=this.records,s=Array.from(e.authorities.values()).sort(fi.rrComparator),i=fi.runTiebreaking(n,s);i===1?ee("\'%s\' won the tiebreak. We gonna ignore the other probing request!",this.service.getFQDN()):i===-1&&(ee("\'%s\' lost the tiebreak. We are waiting a second and try to probe again...",this.service.getFQDN()),this.endProbing(!1),this.timer=setTimeout(this.sendProbeRequest.bind(this),1e3),this.timer.unref())}};zt.Prober=Kt;Kt.CANCEL_REASON="CIAO PROBING CANCELLED"});var mi=g(Yt=>{"use strict";Object.defineProperty(Yt,"__esModule",{value:!0});Yt.QueryResponse=void 0;var Mc=ze(),tn=class{constructor(e){this.sharedAnswer=!1,this.dnsPacket=new Mc.DNSPacket({type:1}),this.knownAnswers=e}asPacket(){return this.dnsPacket}asString(e){return this.dnsPacket.asLoggingString(e)}containsSharedAnswer(){return this.sharedAnswer}addAnswer(...e){let t=!1;for(let n of e){if(this.isKnownAnswer(n))continue;this.dnsPacket.addAnswers(n)&&(t=!0,n.flushFlag||(this.sharedAnswer=!0))}return t}addAdditional(...e){let t=!1;for(let n of e){if(this.isKnownAnswer(n)||this.dnsPacket.answers.has(n.asString()))continue;this.dnsPacket.addAdditionals(n)&&(t=!0)}return t}markLegacyUnicastResponse(e,t){this.dnsPacket.id=e,t&&this.dnsPacket.addQuestions(...t),this.dnsPacket.answers.forEach(n=>{n.flushFlag=!1,n.ttl=10}),this.dnsPacket.additionals.forEach(n=>{n.flushFlag=!1,n.ttl=10}),this.dnsPacket.setLegacyUnicastEncoding(!0)}markTruncated(){this.dnsPacket.flags.truncation=!0}hasAnswers(){return this.dnsPacket.answers.size>0}isKnownAnswer(e){if(!this.knownAnswers)return!1;let t=this.knownAnswers.get(e.asString());return t!==void 0&&t.ttl>e.ttl/2}static combineResponses(e,t){for(let n=0;n<e.length-1;n++){let s=e[n],i=s.dnsPacket,o=e[n+1],a=o.dnsPacket;i.canBeCombinedWith(a,t)&&(i.combineWith(a),e.splice(n+1,1),s.sharedAnswer=s.sharedAnswer||o.sharedAnswer,n--)}}};Yt.QueryResponse=tn});var vi=g(Zt=>{"use strict";Object.defineProperty(Zt,"__esModule",{value:!0});Zt.QueuedResponse=void 0;var Xt=class r{constructor(e,t){this.timeOfCreation=new Date().getTime(),this.estimatedTimeToBeSent=0,this.delay=-1,this.packet=e,this.interfaceName=t}getPacket(){return this.packet}getTimeSinceCreation(){return new Date().getTime()-this.timeOfCreation}getTimeTillSent(){return Math.max(0,this.estimatedTimeToBeSent-new Date().getTime())}calculateRandomDelay(){this.delay=Math.random()*100+20,this.estimatedTimeToBeSent=new Date().getTime()+this.delay}scheduleResponse(e){this.timer=setTimeout(e,this.delay),this.timer.unref()}delayWouldBeInTimelyManner(e){return e.estimatedTimeToBeSent-this.timeOfCreation<=r.MAX_DELAY}combineWithNextPacketIfPossible(e){return this.interfaceName!==e.interfaceName||!e.packet.canBeCombinedWith(this.packet)?!1:(e.packet.combineWith(this.packet),e.timeOfCreation=Math.min(this.timeOfCreation,e.timeOfCreation),this.timer&&(clearTimeout(this.timer),this.timer=void 0),this.delayed=!0,!0)}combineWithUniqueResponseIfPossible(e,t){return this.interfaceName!==t||!this.packet.canBeCombinedWith(e.asPacket())?!1:(this.packet.combineWith(e.asPacket()),!0)}};Zt.QueuedResponse=Xt;Xt.MAX_DELAY=500});var Ri=g(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.TruncatedQuery=ce.TruncatedQueryEvent=ce.TruncatedQueryResult=void 0;var Fc=w("events"),wi;(function(r){r[r.ABORT=1]="ABORT",r[r.AGAIN_TRUNCATED=2]="AGAIN_TRUNCATED",r[r.FINISHED=3]="FINISHED"})(wi||(ce.TruncatedQueryResult=wi={}));var yi;(function(r){r.TIMEOUT="timeout"})(yi||(ce.TruncatedQueryEvent=yi={}));var rn=class extends Fc.EventEmitter{constructor(e){super(),this.arrivedPackets=1,this.timeOfArrival=new Date().getTime(),this.packet=e,this.timer=this.resetTimer()}getPacket(){return this.packet}getArrivedPacketCount(){return this.arrivedPackets}getTotalWaitTime(){return new Date().getTime()-this.timeOfArrival}appendDNSPacket(e){return this.packet.combineWith(e),this.arrivedPackets++,e.flags.truncation?new Date().getTime()-this.timeOfArrival>5*1e3?1:(this.resetTimer(),2):(clearTimeout(this.timer),this.removeAllListeners(),3)}resetTimer(){return this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.timeout.bind(this),400+Math.random()*100)}timeout(){this.emit("timeout"),this.removeAllListeners()}};ce.TruncatedQuery=rn});var _i=g(nn=>{"use strict";Object.defineProperty(nn,"__esModule",{value:!0});nn.sortedInsert=kc;function kc(r,e,t){let n=0,s=r.length-1,i=-1;for(;n<s;){let o=Math.floor((n+s)/2),a=t(e,r[o]);if(a===0){i=o+1;break}a<0?s=o-1:n=o+1}r.length===0?i=0:i<0&&(t(e,r[n])>0?i=n+1:i=n),r.splice(i,0,e)}});var an=g(Jt=>{"use strict";Object.defineProperty(Jt,"__esModule",{value:!0});Jt.Responder=void 0;var Ci=(N(),A(C)),ue=Ci.__importDefault(w("assert")),xc=Ci.__importDefault(Z()),Uc=$r(),qc=ze(),Bc=jt(),jc=_t(),Qc=bt(),sn=Lt(),$c=Dt(),Gc=kt(),Ze=$t(),Je=ui(),Si=gi(),et=mi(),bi=vi(),Wc=Ri(),Ei=Vr(),on=Qt(),Hc=_i(),_=(0,xc.default)("ciao:Responder"),Vc=(r,e)=>r.estimatedTimeToBeSent-e.estimatedTimeToBeSent,Ai;(function(r){r[r.NO_CONFLICT=0]="NO_CONFLICT",r[r.CONFLICTING_RDATA=1]="CONFLICTING_RDATA",r[r.CONFLICTING_TTL=2]="CONFLICTING_TTL"})(Ai||(Ai={}));var tt=class r{static getResponder(e){let t=e?JSON.stringify(e):"",n=this.INSTANCES.get(t);if(n)return n.refCount++,n;{let s=new r(e);return this.INSTANCES.set(t,s),s.optionsString=t,s}}constructor(e){this.refCount=1,this.optionsString="",this.bound=!1,this.announcedServices=new Map,this.servicePointer=new Map,this.truncatedQueries={},this.delayedMulticastResponses=[],this.server=new Ze.MDNSServer(this,e),this.promiseChain=this.start(),this.server.getNetworkManager().on("network-update",this.handleNetworkUpdate.bind(this)),this.ignoreUnicastResponseFlag=e?.ignoreUnicastResponseFlag,e?.periodicBroadcasts&&(this.broadcastInterval=setTimeout(this.handlePeriodicBroadcasts.bind(this),3e4).unref())}handlePeriodicBroadcasts(){this.broadcastInterval=void 0,_("Sending periodic announcement on "+Array.from(this.server.getNetworkManager().getInterfaceMap().keys()).join(", "));let e=Array.from(this.server.getBoundInterfaceNames());for(let t of this.server.getNetworkManager().getInterfaceMap().values()){let n=new Bc.Question("_hap._tcp.local.",12,!1),s=[],i=[];e.includes(t.name)&&(s=this.answerQuestion(n,{port:5353,address:t.ipv4Netaddress,interface:t.name})),e.includes(t.name+"/6")&&(i=this.answerQuestion(n,{port:5353,address:t.ipv6,interface:t.name+"/6"}));let o=[...s,...i];et.QueryResponse.combineResponses(o);for(let a of o)a.hasAnswers()&&this.server.sendResponse(a.asPacket(),t.name)}this.broadcastInterval=setTimeout(this.handlePeriodicBroadcasts.bind(this),Math.random()*3e3+27e3).unref()}createService(e){let t=new Uc.CiaoService(this.server.getNetworkManager(),e);return t.on("publish",this.advertiseService.bind(this,t)),t.on("unpublish",this.unpublishService.bind(this,t)),t.on("republish",this.republishService.bind(this,t)),t.on("records-update",this.handleServiceRecordUpdate.bind(this,t)),t.on("records-update-interface",this.handleServiceRecordUpdateOnInterface.bind(this,t)),t}shutdown(){if(this.refCount--,this.refCount>0)return Promise.resolve();this.currentProber&&this.currentProber.cancel(),this.broadcastInterval&&clearTimeout(this.broadcastInterval),r.INSTANCES.delete(this.optionsString),_("Shutting down Responder...");let e=[];for(let t of this.announcedServices.values())e.push(this.unpublishService(t));return Promise.all(e).then(()=>{this.server.shutdown(),this.bound=!1})}getAnnouncedServices(){return this.announcedServices.values()}start(){if(this.bound)throw new Error("Server is already bound!");return this.bound=!0,this.server.bind()}advertiseService(e,t){if(e.serviceState==="announced")throw new Error("Can\'t publish a service that is already announced. Received "+e.serviceState+" for service "+e.getFQDN());return e.serviceState==="probing"?this.promiseChain.then(()=>{if(e.currentAnnouncer)return e.currentAnnouncer.awaitAnnouncement()}):e.serviceState==="announcing"?((0,ue.default)(e.currentAnnouncer,"Service is in state ANNOUNCING though has no linked announcer!"),e.currentAnnouncer.isSendingGoodbye()?e.currentAnnouncer.awaitAnnouncement().then(()=>this.advertiseService(e,t)):e.currentAnnouncer.cancel().then(()=>this.advertiseService(e,t))):(_("[%s] Going to advertise service...",e.getFQDN()),this.promiseChain=this.promiseChain.then(()=>e.rebuildServiceRecords()).then(()=>this.probe(e)),this.promiseChain.then(()=>{this.announce(e).catch(n=>(console.log(`[${e.getFQDN()}] failed announcing with reason: ${n}. Trying again in 2 seconds!`),(0,on.PromiseTimeout)(2e3).then(()=>this.advertiseService(e,()=>{})))),t()},n=>{if(n===Si.Prober.CANCEL_REASON)t();else return console.log(`[${e.getFQDN()}] failed probing with reason: ${n}. Trying again in 2 seconds!`),(0,on.PromiseTimeout)(2e3).then(()=>this.advertiseService(e,t))}))}async republishService(e,t,n=!1){if(e.serviceState!=="announced"&&e.serviceState!=="announcing")throw new Error("Can\'t unpublish a service which isn\'t announced yet. Received "+e.serviceState+" for service "+e.getFQDN());return _("[%s] Readvertising service...",e.getFQDN()),e.serviceState==="announcing"?((0,ue.default)(e.currentAnnouncer,"Service is in state ANNOUNCING though has no linked announcer!"),(e.currentAnnouncer.isSendingGoodbye()?e.currentAnnouncer.awaitAnnouncement():e.currentAnnouncer.cancel()).then(()=>this.advertiseService(e,t))):(this.clearService(e),e.serviceState="unannounced",n?(0,on.PromiseTimeout)(1e3).then(()=>this.advertiseService(e,t)):this.advertiseService(e,t))}unpublishService(e,t){if(e.serviceState==="unannounced")throw new Error("Can\'t unpublish a service which isn\'t announced yet. Received "+e.serviceState+" for service "+e.getFQDN());if(e.serviceState==="announced"||e.serviceState==="announcing"){if(e.serviceState==="announcing")return(0,ue.default)(e.currentAnnouncer,"Service is in state ANNOUNCING though has no linked announcer!"),e.currentAnnouncer.isSendingGoodbye()?e.currentAnnouncer.awaitAnnouncement():e.currentAnnouncer.cancel().then(()=>(e.serviceState="announced",this.unpublishService(e,t)));_("[%s] Removing service from the network",e.getFQDN()),this.clearService(e),e.serviceState="unannounced";let n=this.goodbye(e);return t&&(n=n.then(()=>t(),s=>{console.log(`[${e.getFQDN()}] failed goodbye with reason: ${s}.`),t()})),n}else e.serviceState==="probing"&&(_("[%s] Canceling probing",e.getFQDN()),this.currentProber&&this.currentProber.getService()===e&&(this.currentProber.cancel(),this.currentProber=void 0),e.serviceState="unannounced");return typeof t=="function"&&t(),Promise.resolve()}clearService(e){let t=e.getLowerCasedFQDN(),n=e.getLowerCasedTypePTR(),s=e.getLowerCasedSubtypePTRs();if(this.removePTR(r.SERVICE_TYPE_ENUMERATION_NAME,n),this.removePTR(n,t),s)for(let i of s)this.removePTR(i,t);this.announcedServices.delete(e.getLowerCasedFQDN())}addPTR(e,t){let n=this.servicePointer.get(e);n?n.includes(t)||n.push(t):this.servicePointer.set(e,[t])}removePTR(e,t){let n=this.servicePointer.get(e);if(n){let s=n.indexOf(t);s!==-1&&n.splice(s,1),n.length===0&&this.servicePointer.delete(e)}}probe(e){if(e.serviceState!=="unannounced")throw new Error("Can\'t probe for a service which is announced already. Received "+e.serviceState+" for service "+e.getFQDN());return e.serviceState="probing",(0,ue.default)(this.currentProber===void 0,"Tried creating new Prober when there already was one active!"),this.currentProber=new Si.Prober(this,this.server,e),this.currentProber.probe().then(()=>{this.currentProber=void 0,e.serviceState="probed"},t=>(e.serviceState="unannounced",this.currentProber=void 0,Promise.reject(t)))}announce(e){if(e.serviceState!=="probed")throw new Error("Cannot announce service which was not probed unique. Received "+e.serviceState+" for service "+e.getFQDN());(0,ue.default)(e.currentAnnouncer===void 0,"Service "+e.getFQDN()+" is already announcing!"),e.serviceState="announcing";let t=new Je.Announcer(this.server,e,{repetitions:3});e.currentAnnouncer=t;let n=e.getLowerCasedFQDN(),s=e.getLowerCasedTypePTR(),i=e.getLowerCasedSubtypePTRs();if(this.addPTR(r.SERVICE_TYPE_ENUMERATION_NAME,s),this.addPTR(s,n),i)for(let o of i)this.addPTR(o,n);return this.announcedServices.set(n,e),t.announce().then(()=>{e.serviceState="announced",e.currentAnnouncer=void 0},o=>{if(e.serviceState="unannounced",e.currentAnnouncer=void 0,this.clearService(e),o!==Je.Announcer.CANCEL_REASON)return Promise.reject(o)})}handleServiceRecordUpdate(e,t,n){var s;if(e.serviceState!=="announced")throw new Error("Cannot update txt of service which is not announced yet. Received "+e.serviceState+" for service "+e.getFQDN());_("[%s] Updating %d record(s) for given service!",e.getFQDN(),t.answers.length+(((s=t.additionals)===null||s===void 0?void 0:s.length)||0)),this.server.sendResponseBroadcast(t,e).then(i=>{let o=(0,Ze.SendResultFailedRatio)(i);if(o===1){console.log((0,Ze.SendResultFormatError)(i,`Failed to send records update for \'${e.getFQDN()}\'`),!0),n&&n(new Error("Updating records failed as of socket errors!"));return}o>0&&_((0,Ze.SendResultFormatError)(i,`Some of the record updates for \'${e.getFQDN()}\' failed`)),n&&n()})}handleServiceRecordUpdateOnInterface(e,t,n,s){if(e.serviceState!=="announced")throw new Error("Cannot update txt of service which is not announced yet. Received "+e.serviceState+" for service "+e.getFQDN());_("[%s] Updating %d record(s) for given service on interface %s!",e.getFQDN(),n.length,t);let i=qc.DNSPacket.createDNSResponsePacketsFromRRSet({answers:n});this.server.sendResponse(i,t,s)}goodbye(e){(0,ue.default)(e.currentAnnouncer===void 0,"Service "+e.getFQDN()+" is already announcing!"),e.serviceState="announcing";let t=new Je.Announcer(this.server,e,{repetitions:1,goodbye:!0});return e.currentAnnouncer=t,t.announce().then(()=>{e.serviceState="unannounced",e.currentAnnouncer=void 0},n=>(e.serviceState="unannounced",e.currentAnnouncer=void 0,Promise.reject(n)))}handleNetworkUpdate(e){for(let t of this.announcedServices.values())t.handleNetworkInterfaceUpdate(e)}handleQuery(e,t){let n=new Date().getTime(),s=t.address+":"+t.port+":"+t.interface,i=this.truncatedQueries[s];if(i)switch(i.appendDNSPacket(e)){case 1:delete this.truncatedQueries[s],_("[%s] Aborting to wait for more truncated queries. Waited a total of %d ms receiving %d queries",s,i.getTotalWaitTime(),i.getArrivedPacketCount());return;case 2:_("[%s] Received a query marked as truncated, waiting for more to arrive",s);return;case 3:delete this.truncatedQueries[s],e=i.getPacket(),_("[%s] Last part of the truncated query arrived. Received %d packets taking a total of %d ms",s,i.getArrivedPacketCount(),i.getTotalWaitTime());break}else if(e.flags.truncation){_("Received truncated query from "+JSON.stringify(t)+" waiting for more to come!");let l=new Wc.TruncatedQuery(e);this.truncatedQueries[s]=l,l.on("timeout",()=>{_("[%s] Timeout passed since the last truncated query was received. Discarding %d packets received in %d ms.",s,l.getArrivedPacketCount(),l.getTotalWaitTime()),delete this.truncatedQueries[s]});return}let o=t.port!==Ze.MDNSServer.MDNS_PORT,a=e.authorities.size>0,c;for(let l of e.additionals.values())if(l.type===41){c=l.udpPayloadSize;break}let u=[],d=[];if(e.questions.forEach(l=>{let h=this.answerQuestion(l,t,e.answers);o||l.unicastResponseFlag&&!this.ignoreUnicastResponseFlag?d.push(...h):u.push(...h)}),this.currentProber&&this.currentProber.handleQuery(e,t),o)for(let l=0;l<d.length;l++)d[l].markLegacyUnicastResponse(e.id,l===0?Array.from(e.questions.values()):void 0);et.QueryResponse.combineResponses(u,c),et.QueryResponse.combineResponses(d,c),o&&d.length>1&&(d.splice(1,d.length-1),d[0].markTruncated());for(let l of d){if(!l.hasAnswers())continue;this.server.sendResponse(l.asPacket(),t);let h=new Date().getTime()-n;_("Sending response via unicast to %s (took %d ms): %s",JSON.stringify(t),h,l.asString(c))}for(let l of u)if(l.hasAnswers())if((l.containsSharedAnswer()||e.questions.size>1)&&!a){let h=new Date().getTime()-n;this.enqueueDelayedMulticastResponse(l.asPacket(),t.interface,h)}else{let h=!1;for(let f=0;f<this.delayedMulticastResponses.length;f++){let v=this.delayedMulticastResponses[f];if(v.getTimeTillSent()>bi.QueuedResponse.MAX_DELAY)break;if(v.combineWithUniqueResponseIfPossible(l,t.interface)){let m=new Date().getTime()-n;h=!0,_("Multicast response on interface %s containing unique records (took %d ms) was combined with response which is sent out later",t.interface,m);break}}if(!h){this.server.sendResponse(l.asPacket(),t.interface);let f=new Date().getTime()-n;_("Sending response via multicast on network %s (took %d ms): %s",t.interface,f,l.asString(c))}}}handleResponse(e,t){this.currentProber&&this.currentProber.handleResponse(e,t);for(let n of this.announcedServices.values()){let s=!1,i=0;for(let o of e.answers.values()){let a=r.checkRecordConflictType(n,o,t);if(a===1){s=!0;break}else a===2&&i++}if(!s)for(let o of e.additionals.values()){let a=r.checkRecordConflictType(n,o,t);if(a===1){s=!0;break}else a===2&&i++}if(s)this.republishService(n,o=>{o&&(console.log(`FATAL Error occurred trying to resolve conflict for service ${n.getFQDN()}! We can\'t recover from this!`),console.log(o.stack),process.exit(1))},!0);else if(i&&!n.currentAnnouncer){n.serviceState="announcing";let o=new Je.Announcer(this.server,n,{repetitions:1});n.currentAnnouncer=o,o.announce().then(()=>{n.currentAnnouncer=void 0,n.serviceState="announced"},a=>{n.currentAnnouncer=void 0,n.serviceState="announced",a!==Je.Announcer.CANCEL_REASON&&console.warn("When trying to resolve a ttl conflict on the network, we were unable to send our response packet: "+a.message)})}}}static checkRecordConflictType(e,t,n){if(!e.advertisesOnInterface(n.interface))return 0;let s=t.getLowerCasedName();if(s===e.getLowerCasedFQDN()){if(t.type===33){let i=t;if(i.getLowerCasedHostname()!==e.getLowerCasedHostname())return _("[%s] Noticed conflicting record on the network. SRV with hostname: %s",e.getFQDN(),i.hostname),1;if(i.port!==e.getPort())return _("[%s] Noticed conflicting record on the network. SRV with port: %s",e.getFQDN(),i.port),1;if(i.ttl<$c.SRVRecord.DEFAULT_TTL/2)return 2}else if(t.type===16){let i=t,o=e.getTXT();if(o.length!==i.txt.length)return _("[%s] Noticed conflicting record on the network. TXT with differing data length",e.getFQDN()),1;for(let a=0;a<o.length;a++){let c=o[a],u=i.txt[a];if(c.length!==u.length||c.toString("hex")!==u.toString("hex"))return _("[%s] Noticed conflicting record on the network. TXT with differing data.",e.getFQDN()),1}if(i.ttl<Gc.TXTRecord.DEFAULT_TTL/2)return 2}}else if(s===e.getLowerCasedHostname()){if(t.type===1){let i=t;if(!e.hasAddress(i.ipAddress))return _("[%s] Noticed conflicting record on the network. A with ip address: %s",e.getFQDN(),i.ipAddress),1;if(i.ttl<Qc.ARecord.DEFAULT_TTL/2)return 2}else if(t.type===28){let i=t;if(!e.hasAddress(i.ipAddress))return _("[%s] Noticed conflicting record on the network. AAAA with ip address: %s",e.getFQDN(),i.ipAddress),1;if(i.ttl<jc.AAAARecord.DEFAULT_TTL/2)return 2}}else if(t.type===12){let i=t;if(s===e.getLowerCasedTypePTR()){if(i.getLowerCasedPTRName()===e.getLowerCasedFQDN()&&i.ttl<sn.PTRRecord.DEFAULT_TTL/2)return 2}else if(s!==r.SERVICE_TYPE_ENUMERATION_NAME){let o=e.getLowerCasedSubtypePTRs();if(o&&o.includes(s)&&i.getLowerCasedPTRName()===e.getLowerCasedFQDN()&&i.ttl<sn.PTRRecord.DEFAULT_TTL/2)return 2}}return 0}enqueueDelayedMulticastResponse(e,t,n){let s=new bi.QueuedResponse(e,t);s.calculateRandomDelay(),(0,Hc.sortedInsert)(this.delayedMulticastResponses,s,Vc);for(let i=0;i<this.delayedMulticastResponses.length;i++){let o=this.delayedMulticastResponses[i];for(let a=i+1;a<this.delayedMulticastResponses.length;a++){let c=this.delayedMulticastResponses[a];if(!o.delayWouldBeInTimelyManner(c))break;if(o.combineWithNextPacketIfPossible(c)){let u=this.delayedMulticastResponses.indexOf(o);u!==-1&&this.delayedMulticastResponses.splice(u,1),i--;break}}}s.delayed||s.scheduleResponse(()=>{let i=this.delayedMulticastResponses.indexOf(s);i!==-1&&this.delayedMulticastResponses.splice(i,1);try{this.server.sendResponse(s.getPacket(),t),_("Sending (delayed %dms) response via multicast on network interface %s (took %d ms): %s",Math.round(s.getTimeSinceCreation()),t,n,s.getPacket().asLoggingString())}catch(o){if(o.name===Ei.ERR_INTERFACE_NOT_FOUND)_("Multicast response (delayed %dms) was cancelled as the network interface %s is no longer available!",Math.round(s.getTimeSinceCreation()),t);else if(o.name===Ei.ERR_SERVER_CLOSED)_("Multicast response (delayed %dms) was cancelled as the server is about to be shutdown!",Math.round(s.getTimeSinceCreation()));else throw o}})}answerQuestion(e,t,n){if(e.class!==1&&e.class!==255)return[];let s=[],i;if(e.type===12||e.type===255||e.type===5){let o=this.servicePointer.get(e.getLowerCasedName());if(o){for(let a of o){let c=this.announcedServices.get(a);if(c){if(c.advertisesOnInterface(t.interface)){let u=r.answerServiceQuestion(c,e,t,n);u.hasAnswers()&&s.push(u)}}else i||(i=new et.QueryResponse(n),s.unshift(i)),i.addAnswer(new sn.PTRRecord(e.name,a))}return s}}for(let o of this.announcedServices.values()){if(!o.advertisesOnInterface(t.interface))continue;let a=r.answerServiceQuestion(o,e,t,n);a.hasAnswers()&&s.push(a)}return s}static answerServiceQuestion(e,t,n,s){let i=new et.QueryResponse(s),o=t.getLowerCasedName(),a=t.type===255||t.type===5,c=i.addAnswer.bind(i),u=i.addAdditional.bind(i);if(o===e.getLowerCasedTypePTR())(a||t.type===12)&&i.addAnswer(e.ptrRecord())&&(i.addAdditional(e.txtRecord(),e.srvRecord()),this.addAddressRecords(e,n,1,u),this.addAddressRecords(e,n,28,u),i.addAdditional(e.serviceNSECRecord(),e.addressNSECRecord()));else if(o===e.getLowerCasedFQDN())a?(i.addAnswer(e.txtRecord()),i.addAnswer(e.srvRecord())&&(this.addAddressRecords(e,n,1,u),this.addAddressRecords(e,n,28,u),i.addAdditional(e.serviceNSECRecord(),e.addressNSECRecord()))):t.type===33?i.addAnswer(e.srvRecord())&&(this.addAddressRecords(e,n,1,u),this.addAddressRecords(e,n,28,u),i.addAdditional(e.serviceNSECRecord(!0),e.addressNSECRecord())):t.type===16&&(i.addAnswer(e.txtRecord()),i.addAdditional(e.serviceNSECRecord()));else if(o===e.getLowerCasedHostname()||o+"local."===e.getLowerCasedHostname())a?(this.addAddressRecords(e,n,1,c),this.addAddressRecords(e,n,28,c),i.addAdditional(e.addressNSECRecord())):t.type===1?(this.addAddressRecords(e,n,1,c)&&this.addAddressRecords(e,n,28,u),i.addAdditional(e.addressNSECRecord())):t.type===28&&(this.addAddressRecords(e,n,28,c)&&this.addAddressRecords(e,n,1,u),i.addAdditional(e.addressNSECRecord()));else if(e.getLowerCasedSubtypePTRs()&&(a||t.type===12)){let l=e.getLowerCasedSubtypePTRs().indexOf(o);if(l!==-1){let f=e.subtypePtrRecords()[l];(0,ue.default)(o===f.name,"Question Name didn\'t match selected sub type ptr record!"),i.addAnswer(f)&&(i.addAdditional(e.txtRecord(),e.srvRecord()),this.addAddressRecords(e,n,1,u),this.addAddressRecords(e,n,28,u),i.addAdditional(e.serviceNSECRecord(),e.addressNSECRecord()))}}return i}static addAddressRecords(e,t,n,s){let i=t.interface.endsWith("/6")?t.interface.substr(0,t.interface.length-2):t.interface;if(n===1){let o=e.aRecord(i);return o?s(o):!1}else if(n===28){let o=e.aaaaRecord(i),a=e.aaaaRoutableRecord(i),c=e.aaaaUniqueLocalRecord(i),u=!1;if(o&&(u=s(o)),a){let d=s(a);u=u||d}if(c){let d=s(c);u=u||d}return u}else ue.default.fail("Illegal argument!")}};Jt.Responder=tt;tt.SERVICE_TYPE_ENUMERATION_NAME="_services._dns-sd._udp.local.";tt.INSTANCES=new Map});var Gr=g(de=>{"use strict";Object.defineProperty(de,"__esModule",{value:!0});de.Protocol=void 0;de.getResponder=Ti;var un=(N(),A(C));vs();var cn=un.__importDefault(Z()),Ii=Es().version;if(Ii.includes("beta")||process.env.BCT){let r=process.env.DEBUG;(!r||!r.includes("ciao"))&&(r?cn.default.enable(r+",ciao:*"):cn.default.enable("ciao:*"))}Ur();var Kc=an();un.__exportStar($r(),de);un.__exportStar(an(),de);function zc(){(0,cn.default)("ciao:init")("Loading ciao v"+Ii+"...")}zc();var Ni;(function(r){r.TCP="tcp",r.UDP="udp"})(Ni||(de.Protocol=Ni={}));function Ti(r){return Kc.Responder.getResponder(r)}de.default={getResponder:Ti}});var ru={};fn(ru,{closeConnect:()=>tu,openConnect:()=>eu});var ln=tr(w("os")),Pi=w("crypto"),Oi=w("path"),Di=tr(w("process")),Mi=tr(Gr());var Yc=w((0,Oi.join)(Di.default.mainModule.path,"main/remoteDesktop/RemoteDesktopController.js")).default;function Xc(){let r=ln.default.hostname();return(0,Pi.createHash)("md5").update(r).digest("hex")}function Zc(){return`Desktop: ${ln.default.hostname().split(".")[0]}`}var Jc=Mi.getResponder(),Li=Xc(),dn=Jc.createService({disabledIpv6:!0,port:2019,type:"tidalconnect",name:`RemoteDesktop-${Li}`,txt:{mn:"RemoteDesktop",id:Li,fn:Zc(),ca:"0",ve:"1"}});function eu(){globalThis.neptuneRemoteDesktop||(globalThis.neptuneRemoteDesktop=new Yc,neptuneRemoteDesktop.mdnsStartBroadcasting=()=>dn.advertise(),neptuneRemoteDesktop.mdnsStopBroadcasting=()=>dn.end())}function tu(){dn.end()}return A(ru);})();\n'),a=NeptuneNative.getNativeValue(i,"closeConnect"),c=NeptuneNative.getNativeValue(i,"openConnect");d(()=>NeptuneNative.deleteEvalScope(i));var n="twnlink-desktopconnect-banner",m=h(`
#${n} {
  text-align: center;
  min-height: 35px;
  width: 100vw;
  background-color: var(--wave-color-opacity-accent-fill-ultra-thick);
  display: grid;
  place-items: center;
}

#${n}[hidden] {
  display: none;
}`),r;c();window.ranRemoteDesktopRootSaga||setTimeout(()=>{let s=(()=>{for(let e of neptune.modules){if(!e?.exports)continue;let t=Object.values(e.exports).find(o=>o?.setContext&&o?.run);if(t)return t}})(),u=neptune.modules.find(e=>e?.exports&&e?.exports?.rootSaga)?.exports.rootSaga,l=(()=>{let e=u(),t;for(;!t?.done&&t?.value?.type!="CALL";)t=e.next();return e.next(!0).value})().payload.fn;s.run(l),window.ranRemoteDesktopRootSaga=!0},1500);g(f("remotePlayback/remoteDesktop/STATE_CHANGED",([s])=>{r||(document.querySelector('div[class^="bar--"]').insertAdjacentHTML("afterend",`
    <div hidden id="${n}">
      <div>
        The player is currently being controlled by TIDAL Connect.
      </div>
    </div>`),r=document.getElementById(n)),s==0?r.setAttribute("hidden",""):r.removeAttribute("hidden")}));function E(){a(),p({type:"remotePlayback/remoteDesktop/STATE_CHANGED",payload:0}),r?.remove?.(),m()}export{E as onUnload};
