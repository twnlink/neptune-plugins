import{appendStyle as p}from"@neptune/utils";import{intercept as d}from"@neptune";import{dispatch as m}from"@neptune/store";import{addUnloadable as c}from"@plugin";var s=NeptuneNative.createEvalScope('var neptuneExports=(()=>{var I=Object.create;var h=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var S=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var l=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+t+\'" is not supported\')});var P=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),F=(t,e)=>{for(var r in e)h(t,r,{get:e[r],enumerable:!0})},v=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of R(e))!D.call(t,o)&&o!==r&&h(t,o,{get:()=>e[o],enumerable:!(n=b(e,o))||n.enumerable});return t};var m=(t,e,r)=>(r=t!=null?I(S(t)):{},v(e||!t||!t.__esModule?h(r,"default",{value:t,enumerable:!0}):r,t)),q=t=>v(h({},"__esModule",{value:!0}),t);var L=P(B=>{var s=B,{Buffer:g}=l("buffer"),E=l("os");s.toBuffer=function(t,e,r){r=~~r;let n;if(this.isV4Format(t))n=e||g.alloc(r+4),t.split(/\\./g).map(o=>{n[r++]=parseInt(o,10)&255});else if(this.isV6Format(t)){let o=t.split(":",8),f;for(f=0;f<o.length;f++){let i=this.isV4Format(o[f]),u;i&&(u=this.toBuffer(o[f]),o[f]=u.slice(0,2).toString("hex")),u&&++f<8&&o.splice(f,0,u.slice(2,4).toString("hex"))}if(o[0]==="")for(;o.length<8;)o.unshift("0");else if(o[o.length-1]==="")for(;o.length<8;)o.push("0");else if(o.length<8){for(f=0;f<o.length&&o[f]!=="";f++);let i=[f,1];for(f=9-o.length;f>0;f--)i.push("0");o.splice(...i)}for(n=e||g.alloc(r+16),f=0;f<o.length;f++){let i=parseInt(o[f],16);n[r++]=i>>8&255,n[r++]=i&255}}if(!n)throw Error(`Invalid ip address: ${t}`);return n};s.toString=function(t,e,r){e=~~e,r=r||t.length-e;let n=[];if(r===4){for(let o=0;o<r;o++)n.push(t[e+o]);n=n.join(".")}else if(r===16){for(let o=0;o<r;o+=2)n.push(t.readUInt16BE(e+o).toString(16));n=n.join(":"),n=n.replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3"),n=n.replace(/:{3,4}/,"::")}return n};var A=/^(\\d{1,3}\\.){3,3}\\d{1,3}$/,C=/^(::)?(((\\d{1,3}\\.){3}(\\d{1,3}){1})?([0-9a-f]){0,4}:{0,2}){1,8}(::)?$/i;s.isV4Format=function(t){return A.test(t)};s.isV6Format=function(t){return C.test(t)};function c(t){return t===4?"ipv4":t===6?"ipv6":t?t.toLowerCase():"ipv4"}s.fromPrefixLen=function(t,e){t>32?e="ipv6":e=c(e);let r=4;e==="ipv6"&&(r=16);let n=g.alloc(r);for(let o=0,f=n.length;o<f;++o){let i=8;t<8&&(i=t),t-=i,n[o]=~(255>>i)&255}return s.toString(n)};s.mask=function(t,e){t=s.toBuffer(t),e=s.toBuffer(e);let r=g.alloc(Math.max(t.length,e.length)),n;if(t.length===e.length)for(n=0;n<t.length;n++)r[n]=t[n]&e[n];else if(e.length===4)for(n=0;n<e.length;n++)r[n]=t[t.length-4+n]&e[n];else{for(n=0;n<r.length-6;n++)r[n]=0;for(r[10]=255,r[11]=255,n=0;n<t.length;n++)r[n+12]=t[n]&e[n+12];n+=12}for(;n<r.length;n++)r[n]=0;return s.toString(r)};s.cidr=function(t){let e=t.split("/"),r=e[0];if(e.length!==2)throw new Error(`invalid CIDR subnet: ${r}`);let n=s.fromPrefixLen(parseInt(e[1],10));return s.mask(r,n)};s.subnet=function(t,e){let r=s.toLong(s.mask(t,e)),n=s.toBuffer(e),o=0;for(let i=0;i<n.length;i++)if(n[i]===255)o+=8;else{let u=n[i]&255;for(;u;)u=u<<1&255,o++}let f=2**(32-o);return{networkAddress:s.fromLong(r),firstAddress:f<=2?s.fromLong(r):s.fromLong(r+1),lastAddress:f<=2?s.fromLong(r+f-1):s.fromLong(r+f-2),broadcastAddress:s.fromLong(r+f-1),subnetMask:e,subnetMaskLength:o,numHosts:f<=2?f:f-2,length:f,contains(i){return r===s.toLong(s.mask(i,e))}}};s.cidrSubnet=function(t){let e=t.split("/"),r=e[0];if(e.length!==2)throw new Error(`invalid CIDR subnet: ${r}`);let n=s.fromPrefixLen(parseInt(e[1],10));return s.subnet(r,n)};s.not=function(t){let e=s.toBuffer(t);for(let r=0;r<e.length;r++)e[r]=255^e[r];return s.toString(e)};s.or=function(t,e){if(t=s.toBuffer(t),e=s.toBuffer(e),t.length===e.length){for(let f=0;f<t.length;++f)t[f]|=e[f];return s.toString(t)}let r=t,n=e;e.length>t.length&&(r=e,n=t);let o=r.length-n.length;for(let f=o;f<r.length;++f)r[f]|=n[f-o];return s.toString(r)};s.isEqual=function(t,e){if(t=s.toBuffer(t),e=s.toBuffer(e),t.length===e.length){for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}if(e.length===4){let n=e;e=t,t=n}for(let n=0;n<10;n++)if(e[n]!==0)return!1;let r=e.readUInt16BE(10);if(r!==0&&r!==65535)return!1;for(let n=0;n<4;n++)if(t[n]!==e[n+12])return!1;return!0};s.isPrivate=function(t){if(s.isLoopback(t))return!0;if(!s.isV6Format(t)){let e=s.normalizeToLong(t);if(e<0)throw new Error("invalid ipv4 address");t=s.fromLong(e)}return/^(::f{4}:)?10\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?192\\.168\\.([0-9]{1,3})\\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?172\\.(1[6-9]|2\\d|30|31)\\.([0-9]{1,3})\\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?169\\.254\\.([0-9]{1,3})\\.([0-9]{1,3})$/i.test(t)||/^f[cd][0-9a-f]{2}:/i.test(t)||/^fe80:/i.test(t)||/^::1$/.test(t)||/^::$/.test(t)};s.isPublic=function(t){return!s.isPrivate(t)};s.isLoopback=function(t){return!/\\./.test(t)&&!/:/.test(t)&&(t=s.fromLong(Number(t))),/^(::f{4}:)?127\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})/.test(t)||/^0177\\./.test(t)||/^0x7f\\./i.test(t)||/^fe80::1$/i.test(t)||/^::1$/.test(t)||/^::$/.test(t)};s.loopback=function(t){if(t=c(t),t!=="ipv4"&&t!=="ipv6")throw new Error("family must be ipv4 or ipv6");return t==="ipv4"?"127.0.0.1":"fe80::1"};s.address=function(t,e){let r=E.networkInterfaces();if(e=c(e),t&&t!=="private"&&t!=="public"){let o=r[t].filter(f=>c(f.family)===e);return o.length===0?void 0:o[0].address}let n=Object.keys(r).map(o=>{let f=r[o].filter(i=>(i.family=c(i.family),i.family!==e||s.isLoopback(i.address)?!1:t?t==="public"?s.isPrivate(i.address):s.isPublic(i.address):!0));return f.length?f[0].address:void 0}).filter(Boolean);return n.length?n[0]:s.loopback(e)};s.toLong=function(t){let e=0;return t.split(".").forEach(r=>{e<<=8,e+=parseInt(r)}),e>>>0};s.fromLong=function(t){return`${t>>>24}.${t>>16&255}.${t>>8&255}.${t&255}`};s.normalizeToLong=function(t){let e=t.split(".").map(o=>o.startsWith("0x")||o.startsWith("0X")?parseInt(o,16):o.startsWith("0")&&o!=="0"&&/^[0-7]+$/.test(o)?parseInt(o,8):/^[1-9]\\d*$/.test(o)||o==="0"?parseInt(o,10):NaN);if(e.some(isNaN))return-1;let r=0;switch(e.length){case 1:r=e[0];break;case 2:if(e[0]>255||e[1]>16777215)return-1;r=e[0]<<24|e[1]&16777215;break;case 3:if(e[0]>255||e[1]>255||e[2]>65535)return-1;r=e[0]<<24|e[1]<<16|e[2]&65535;break;case 4:if(e.some(o=>o>255))return-1;r=e[0]<<24|e[1]<<16|e[2]<<8|e[3];break;default:return-1}return r>>>0}});var z={};F(z,{closeConnect:()=>_,openConnect:()=>y});var w=m(L()),$=m(l("os")),k=l("crypto"),x=l("path"),d=m(l("process"));var a=l((0,x.join)(d.default.mainModule.path,"../node_modules/multicast-dns"))(),M=l((0,x.join)(d.default.mainModule.path,"main/remoteDesktop/RemoteDesktopController.js")).default;function T(){let t=$.default.hostname();return{deviceId:(0,k.createHash)("md5").update(t).digest("hex"),hostname:t}}function V(){return`Desktop: ${$.default.hostname().split(".")[0]}`}function j({friendlyName:t,modelName:e,serviceName:r}){let{deviceId:n,hostname:o}=T();t=t||V();let f=w.default.address();!n||!o||!f||a.on("query",(i,u)=>{if(i.questions.filter(p=>p.name===r).length>0){let p={additionals:[],answers:[{class:"IN",data:f,flush:!0,name:o,ttl:120,type:"A"},{class:"IN",data:[Buffer.from(`mn=${e}`,"utf8"),Buffer.from("ca=0","utf8"),Buffer.from(`id=${n}`,"utf8"),Buffer.from(`fn=${t}`,"utf8"),Buffer.from("ve=1","utf8")],flush:!0,name:`${e}-${n}.${r}`,ttl:4500,type:"TXT"},{class:"IN",data:`${e}-${n}.${r}`,flush:!1,name:r,ttl:4500,type:"PTR"},{class:"IN",data:{port:2019,priority:0,target:o,weight:0},flush:!0,name:`${e}-${n}.${r}`,ttl:120,type:"SRV"}]};a.respond(p,u)}})}function y(){globalThis.neptuneRemoteDesktop||(globalThis.neptuneRemoteDesktop=new M,neptuneRemoteDesktop.mdnsStartBroadcasting=()=>{j({modelName:"RemoteDesktop",serviceName:"_tidalconnect._tcp.local"})},neptuneRemoteDesktop.mdnsStopBroadcasting=()=>a.destroy())}function _(){a.destroy()}return q(z);})();\n'),f=NeptuneNative.getNativeValue(s,"closeConnect"),l=NeptuneNative.getNativeValue(s,"openConnect");c(()=>NeptuneNative.deleteEvalScope(s));var n="twnlink-desktopconnect-banner",g=p(`
#${n} {
  text-align: center;
  min-height: 35px;
  width: 100vw;
  background-color: var(--wave-color-opacity-accent-fill-ultra-thick);
  display: grid;
  place-items: center;
}

#${n}[hidden] {
  display: none;
}`),r;l();window.ranRemoteDesktopRootSaga||setTimeout(()=>{let o=(()=>{for(let e of neptune.modules){if(!e?.exports)continue;let t=Object.values(e.exports).find(i=>i?.setContext&&i?.run);if(t)return t}})(),a=neptune.modules.find(e=>e?.exports&&e?.exports?.rootSaga)?.exports.rootSaga,u=(()=>{let e=a(),t;for(;!t?.done&&t?.value?.type!="CALL";)t=e.next();return e.next(!0).value})().payload.fn;o.run(u),window.ranRemoteDesktopRootSaga=!0},5e3);d("remotePlayback/remoteDesktop/STATE_CHANGED",([o])=>{r||(document.querySelector('div[class^="bar--"]').insertAdjacentHTML("afterend",`
    <div hidden id="${n}">
      <div>
        The player is currently being controlled by TIDAL Connect.
      </div>
    </div>`),r=document.getElementById(n)),o==0?r.setAttribute("hidden",""):r.removeAttribute("hidden")});function x(){f(),m({type:"remotePlayback/remoteDesktop/STATE_CHANGED",payload:0}),r?.remove?.(),g()}export{x as onUnload};
